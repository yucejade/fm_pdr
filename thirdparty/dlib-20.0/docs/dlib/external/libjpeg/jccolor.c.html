<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - jccolor.c</title></head><body bgcolor='white'><pre>
<font color='#009900'>/*
 * jccolor.c
 *
 * Copyright (C) 1991-1996, Thomas G. Lane.
 * Modified 2011-2019 by Guido Vollbeding.
 * This file is part of the Independent JPEG Group's software.
 * For conditions of distribution and use, see the accompanying README file.
 *
 * This file contains input colorspace conversion routines.
 */</font>

<font color='#0000FF'>#define</font> JPEG_INTERNALS
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='jinclude.h.html'>jinclude.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='jpeglib.h.html'>jpeglib.h</a>"


<font color='#009900'>/* Private subobject */</font>

<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font> <b>{</b>
  <font color='#0000FF'>struct</font> jpeg_color_converter pub; <font color='#009900'>/* public fields */</font>

  <font color='#009900'>/* Private state for RGB-&gt;YCC conversion */</font>
  INT32 <font color='#5555FF'>*</font> rgb_ycc_tab;		<font color='#009900'>/* =&gt; table for RGB to YCbCr conversion */</font>
<b>}</b> my_color_converter;

<font color='#0000FF'>typedef</font> my_color_converter <font color='#5555FF'>*</font> my_cconvert_ptr;


<font color='#009900'>/**************** RGB -&gt; YCbCr conversion: most common case **************/</font>

<font color='#009900'>/*
 * YCbCr is defined per Recommendation ITU-R BT.601-7 (03/2011),
 * previously known as Recommendation CCIR 601-1, except that Cb and Cr
 * are normalized to the range 0..MAXJSAMPLE rather than -0.5 .. 0.5.
 * sRGB (standard RGB color space) is defined per IEC 61966-2-1:1999.
 * sYCC (standard luma-chroma-chroma color space with extended gamut)
 * is defined per IEC 61966-2-1:1999 Amendment A1:2003 Annex F.
 * bg-sRGB and bg-sYCC (big gamut standard color spaces)
 * are defined per IEC 61966-2-1:1999 Amendment A1:2003 Annex G.
 * Note that the derived conversion coefficients given in some of these
 * documents are imprecise.  The general conversion equations are
 *	Y  = Kr * R + (1 - Kr - Kb) * G + Kb * B
 *	Cb = 0.5 * (B - Y) / (1 - Kb)
 *	Cr = 0.5 * (R - Y) / (1 - Kr)
 * With Kr = 0.299 and Kb = 0.114 (derived according to SMPTE RP 177-1993
 * from the 1953 FCC NTSC primaries and CIE Illuminant C),
 * the conversion equations to be implemented are therefore
 *	Y  =  0.299 * R + 0.587 * G + 0.114 * B
 *	Cb = -0.168735892 * R - 0.331264108 * G + 0.5 * B + CENTERJSAMPLE
 *	Cr =  0.5 * R - 0.418687589 * G - 0.081312411 * B + CENTERJSAMPLE
 * Note: older versions of the IJG code used a zero offset of MAXJSAMPLE/2,
 * rather than CENTERJSAMPLE, for Cb and Cr.  This gave equal positive and
 * negative swings for Cb/Cr, but meant that grayscale values (Cb=Cr=0)
 * were not represented exactly.  Now we sacrifice exact representation of
 * maximum red and maximum blue in order to get exact grayscales.
 *
 * To avoid floating-point arithmetic, we represent the fractional constants
 * as integers scaled up by 2^16 (about 4 digits precision); we have to divide
 * the products by 2^16, with appropriate rounding, to get the correct answer.
 *
 * For even more speed, we avoid doing any multiplications in the inner loop
 * by precalculating the constants times R,G,B for all possible values.
 * For 8-bit JSAMPLEs this is very reasonable (only 256 entries per table);
 * for 9-bit to 12-bit samples it is still acceptable.  It's not very
 * reasonable for 16-bit samples, but if you want lossless storage you
 * shouldn't be changing colorspace anyway.
 * The CENTERJSAMPLE offsets and the rounding fudge-factor of 0.5 are included
 * in the tables to save adding them separately in the inner loop.
 */</font>

<font color='#0000FF'>#define</font> SCALEBITS	<font color='#979000'>16</font>	<font color='#009900'>/* speediest right-shift on some machines */</font>
<font color='#0000FF'>#define</font> CBCR_OFFSET	<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> CENTERJSAMPLE <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> SCALEBITS<font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> ONE_HALF	<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>SCALEBITS<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> FIX<font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font>L<font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>SCALEBITS<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>0.5</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

<font color='#009900'>/* We allocate one big table and divide it up into eight parts, instead of
 * doing eight alloc_small requests.  This lets us use a single table base
 * address, which can be held in a register in the inner loops on many
 * machines (more than can hold all eight addresses, anyway).
 */</font>

<font color='#0000FF'>#define</font> R_Y_OFF		<font color='#979000'>0</font>			<font color='#009900'>/* offset to R =&gt; Y section */</font>
<font color='#0000FF'>#define</font> G_Y_OFF		<font face='Lucida Console'>(</font><font color='#979000'>1</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>	<font color='#009900'>/* offset to G =&gt; Y section */</font>
<font color='#0000FF'>#define</font> B_Y_OFF		<font face='Lucida Console'>(</font><font color='#979000'>2</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>	<font color='#009900'>/* etc. */</font>
<font color='#0000FF'>#define</font> R_CB_OFF	<font face='Lucida Console'>(</font><font color='#979000'>3</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> G_CB_OFF	<font face='Lucida Console'>(</font><font color='#979000'>4</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> B_CB_OFF	<font face='Lucida Console'>(</font><font color='#979000'>5</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> R_CR_OFF	B_CB_OFF		<font color='#009900'>/* B=&gt;Cb, R=&gt;Cr are the same */</font>
<font color='#0000FF'>#define</font> G_CR_OFF	<font face='Lucida Console'>(</font><font color='#979000'>6</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> B_CR_OFF	<font face='Lucida Console'>(</font><font color='#979000'>7</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> TABLE_SIZE	<font face='Lucida Console'>(</font><font color='#979000'>8</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>MAXJSAMPLE<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>


<font color='#009900'>/*
 * Initialize for RGB-&gt;YCC colorspace conversion.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='rgb_ycc_start'></a>rgb_ycc_start</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo<font face='Lucida Console'>)</font>
<b>{</b>
  my_cconvert_ptr cconvert <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>my_cconvert_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cconvert;
  INT32 <font color='#5555FF'>*</font> rgb_ycc_tab;
  INT32 i;

  <font color='#009900'>/* Allocate and fill in the conversion tables. */</font>
  cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_ycc_tab <font color='#5555FF'>=</font> rgb_ycc_tab <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>INT32 <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alloc_small<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE,
				TABLE_SIZE <font color='#5555FF'>*</font> <font color='#BB00BB'>SIZEOF</font><font face='Lucida Console'>(</font>INT32<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> MAXJSAMPLE; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
    rgb_ycc_tab[i<font color='#5555FF'>+</font>R_Y_OFF] <font color='#5555FF'>=</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.299</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i;
    rgb_ycc_tab[i<font color='#5555FF'>+</font>G_Y_OFF] <font color='#5555FF'>=</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.587</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i;
    rgb_ycc_tab[i<font color='#5555FF'>+</font>B_Y_OFF] <font color='#5555FF'>=</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.114</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i   <font color='#5555FF'>+</font> ONE_HALF;
    rgb_ycc_tab[i<font color='#5555FF'>+</font>R_CB_OFF] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.168735892</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i;
    rgb_ycc_tab[i<font color='#5555FF'>+</font>G_CB_OFF] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.331264108</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i;
    <font color='#009900'>/* We use a rounding fudge-factor of 0.5-epsilon for Cb and Cr.
     * This ensures that the maximum output will round to MAXJSAMPLE
     * not MAXJSAMPLE+1, and thus that we don't have to range-limit.
     */</font>
    rgb_ycc_tab[i<font color='#5555FF'>+</font>B_CB_OFF] <font color='#5555FF'>=</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i    <font color='#5555FF'>+</font> CBCR_OFFSET <font color='#5555FF'>+</font> ONE_HALF<font color='#5555FF'>-</font><font color='#979000'>1</font>;
<font color='#009900'>/*  B=&gt;Cb and R=&gt;Cr tables are the same
    rgb_ycc_tab[i+R_CR_OFF] = FIX(0.5) * i    + CBCR_OFFSET + ONE_HALF-1;
*/</font>
    rgb_ycc_tab[i<font color='#5555FF'>+</font>G_CR_OFF] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.418687589</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i;
    rgb_ycc_tab[i<font color='#5555FF'>+</font>B_CR_OFF] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font> <font color='#BB00BB'>FIX</font><font face='Lucida Console'>(</font><font color='#979000'>0.081312411</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> i;
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Convert some rows of samples to the JPEG colorspace.
 *
 * Note that we change from the application's interleaved-pixel format
 * to our internal noninterleaved, one-plane-per-component format.  The
 * input buffer is therefore three times as wide as the output buffer.
 *
 * A starting row offset is provided only for the output buffer.  The
 * caller can easily adjust the passed input_buf value to accommodate
 * any row offset required on that side.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='rgb_ycc_convert'></a>rgb_ycc_convert</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo,
		 JSAMPARRAY input_buf, JSAMPIMAGE output_buf,
		 JDIMENSION output_row, <font color='#0000FF'><u>int</u></font> num_rows<font face='Lucida Console'>)</font>
<b>{</b>
  my_cconvert_ptr cconvert <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>my_cconvert_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cconvert;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> r, g, b;
  <font color='#0000FF'>register</font> INT32 <font color='#5555FF'>*</font> ctab <font color='#5555FF'>=</font> cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_ycc_tab;
  <font color='#0000FF'>register</font> JSAMPROW inptr;
  <font color='#0000FF'>register</font> JSAMPROW outptr0, outptr1, outptr2;
  <font color='#0000FF'>register</font> JDIMENSION col;
  JDIMENSION num_cols <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width;

  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>num_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    inptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>input_buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr0 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>0</font>][output_row];
    outptr1 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>1</font>][output_row];
    outptr2 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>2</font>][output_row];
    output_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> <font color='#979000'>0</font>; col <font color='#5555FF'>&lt;</font> num_cols; col<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      r <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_RED]<font face='Lucida Console'>)</font>;
      g <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_GREEN]<font face='Lucida Console'>)</font>;
      b <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_BLUE]<font face='Lucida Console'>)</font>;
      inptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> RGB_PIXELSIZE;
      <font color='#009900'>/* If the inputs are 0..MAXJSAMPLE, the outputs of these equations
       * must be too; we do not need an explicit range-limiting operation.
       * Hence the value being shifted is never negative, and we don't
       * need the general RIGHT_SHIFT macro.
       */</font>
      <font color='#009900'>/* Y */</font>
      outptr0[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ctab[r<font color='#5555FF'>+</font>R_Y_OFF] <font color='#5555FF'>+</font> ctab[g<font color='#5555FF'>+</font>G_Y_OFF] <font color='#5555FF'>+</font> ctab[b<font color='#5555FF'>+</font>B_Y_OFF]<font face='Lucida Console'>)</font>
		 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> SCALEBITS<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* Cb */</font>
      outptr1[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ctab[r<font color='#5555FF'>+</font>R_CB_OFF] <font color='#5555FF'>+</font> ctab[g<font color='#5555FF'>+</font>G_CB_OFF] <font color='#5555FF'>+</font> ctab[b<font color='#5555FF'>+</font>B_CB_OFF]<font face='Lucida Console'>)</font>
		 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> SCALEBITS<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* Cr */</font>
      outptr2[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ctab[r<font color='#5555FF'>+</font>R_CR_OFF] <font color='#5555FF'>+</font> ctab[g<font color='#5555FF'>+</font>G_CR_OFF] <font color='#5555FF'>+</font> ctab[b<font color='#5555FF'>+</font>B_CR_OFF]<font face='Lucida Console'>)</font>
		 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> SCALEBITS<font face='Lucida Console'>)</font>;
    <b>}</b>
  <b>}</b>
<b>}</b>


<font color='#009900'>/**************** Cases other than RGB -&gt; YCbCr **************/</font>


<font color='#009900'>/*
 * Convert some rows of samples to the JPEG colorspace.
 * This version handles RGB-&gt;grayscale conversion, which is the same
 * as the RGB-&gt;Y portion of RGB-&gt;YCbCr.
 * We assume rgb_ycc_start has been called (we only use the Y tables).
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='rgb_gray_convert'></a>rgb_gray_convert</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo,
		  JSAMPARRAY input_buf, JSAMPIMAGE output_buf,
		  JDIMENSION output_row, <font color='#0000FF'><u>int</u></font> num_rows<font face='Lucida Console'>)</font>
<b>{</b>
  my_cconvert_ptr cconvert <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>my_cconvert_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cconvert;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> r, g, b;
  <font color='#0000FF'>register</font> INT32 <font color='#5555FF'>*</font> ctab <font color='#5555FF'>=</font> cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_ycc_tab;
  <font color='#0000FF'>register</font> JSAMPROW inptr;
  <font color='#0000FF'>register</font> JSAMPROW outptr;
  <font color='#0000FF'>register</font> JDIMENSION col;
  JDIMENSION num_cols <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width;

  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>num_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    inptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>input_buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr <font color='#5555FF'>=</font> output_buf[<font color='#979000'>0</font>][output_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>];
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> <font color='#979000'>0</font>; col <font color='#5555FF'>&lt;</font> num_cols; col<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      r <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_RED]<font face='Lucida Console'>)</font>;
      g <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_GREEN]<font face='Lucida Console'>)</font>;
      b <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_BLUE]<font face='Lucida Console'>)</font>;
      inptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> RGB_PIXELSIZE;
      <font color='#009900'>/* Y */</font>
      outptr[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ctab[r<font color='#5555FF'>+</font>R_Y_OFF] <font color='#5555FF'>+</font> ctab[g<font color='#5555FF'>+</font>G_Y_OFF] <font color='#5555FF'>+</font> ctab[b<font color='#5555FF'>+</font>B_Y_OFF]<font face='Lucida Console'>)</font>
		 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> SCALEBITS<font face='Lucida Console'>)</font>;
    <b>}</b>
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Convert some rows of samples to the JPEG colorspace.
 * This version handles Adobe-style CMYK-&gt;YCCK conversion,
 * where we convert R=1-C, G=1-M, and B=1-Y to YCbCr using the
 * same conversion as above, while passing K (black) unchanged.
 * We assume rgb_ycc_start has been called.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='cmyk_ycck_convert'></a>cmyk_ycck_convert</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo,
		   JSAMPARRAY input_buf, JSAMPIMAGE output_buf,
		   JDIMENSION output_row, <font color='#0000FF'><u>int</u></font> num_rows<font face='Lucida Console'>)</font>
<b>{</b>
  my_cconvert_ptr cconvert <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>my_cconvert_ptr<font face='Lucida Console'>)</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cconvert;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> r, g, b;
  <font color='#0000FF'>register</font> INT32 <font color='#5555FF'>*</font> ctab <font color='#5555FF'>=</font> cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_ycc_tab;
  <font color='#0000FF'>register</font> JSAMPROW inptr;
  <font color='#0000FF'>register</font> JSAMPROW outptr0, outptr1, outptr2, outptr3;
  <font color='#0000FF'>register</font> JDIMENSION col;
  JDIMENSION num_cols <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width;

  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>num_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    inptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>input_buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr0 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>0</font>][output_row];
    outptr1 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>1</font>][output_row];
    outptr2 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>2</font>][output_row];
    outptr3 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>3</font>][output_row];
    output_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> <font color='#979000'>0</font>; col <font color='#5555FF'>&lt;</font> num_cols; col<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      r <font color='#5555FF'>=</font> MAXJSAMPLE <font color='#5555FF'>-</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>;
      g <font color='#5555FF'>=</font> MAXJSAMPLE <font color='#5555FF'>-</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[<font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
      b <font color='#5555FF'>=</font> MAXJSAMPLE <font color='#5555FF'>-</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[<font color='#979000'>2</font>]<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* K passes through as-is */</font>
      outptr3[col] <font color='#5555FF'>=</font> inptr[<font color='#979000'>3</font>];	<font color='#009900'>/* don't need GETJSAMPLE here */</font>
      inptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
      <font color='#009900'>/* If the inputs are 0..MAXJSAMPLE, the outputs of these equations
       * must be too; we do not need an explicit range-limiting operation.
       * Hence the value being shifted is never negative, and we don't
       * need the general RIGHT_SHIFT macro.
       */</font>
      <font color='#009900'>/* Y */</font>
      outptr0[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ctab[r<font color='#5555FF'>+</font>R_Y_OFF] <font color='#5555FF'>+</font> ctab[g<font color='#5555FF'>+</font>G_Y_OFF] <font color='#5555FF'>+</font> ctab[b<font color='#5555FF'>+</font>B_Y_OFF]<font face='Lucida Console'>)</font>
		 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> SCALEBITS<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* Cb */</font>
      outptr1[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ctab[r<font color='#5555FF'>+</font>R_CB_OFF] <font color='#5555FF'>+</font> ctab[g<font color='#5555FF'>+</font>G_CB_OFF] <font color='#5555FF'>+</font> ctab[b<font color='#5555FF'>+</font>B_CB_OFF]<font face='Lucida Console'>)</font>
		 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> SCALEBITS<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* Cr */</font>
      outptr2[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font>
		<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ctab[r<font color='#5555FF'>+</font>R_CR_OFF] <font color='#5555FF'>+</font> ctab[g<font color='#5555FF'>+</font>G_CR_OFF] <font color='#5555FF'>+</font> ctab[b<font color='#5555FF'>+</font>B_CR_OFF]<font face='Lucida Console'>)</font>
		 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> SCALEBITS<font face='Lucida Console'>)</font>;
    <b>}</b>
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Convert some rows of samples to the JPEG colorspace.
 * [R,G,B] to [R-G,G,B-G] conversion with modulo calculation
 * (forward reversible color transform).
 * This can be seen as an adaption of the general RGB-&gt;YCbCr
 * conversion equation with Kr = Kb = 0, while replacing the
 * normalization by modulo calculation.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='rgb_rgb1_convert'></a>rgb_rgb1_convert</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo,
		  JSAMPARRAY input_buf, JSAMPIMAGE output_buf,
		  JDIMENSION output_row, <font color='#0000FF'><u>int</u></font> num_rows<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> r, g, b;
  <font color='#0000FF'>register</font> JSAMPROW inptr;
  <font color='#0000FF'>register</font> JSAMPROW outptr0, outptr1, outptr2;
  <font color='#0000FF'>register</font> JDIMENSION col;
  JDIMENSION num_cols <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width;

  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>num_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    inptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>input_buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr0 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>0</font>][output_row];
    outptr1 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>1</font>][output_row];
    outptr2 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>2</font>][output_row];
    output_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> <font color='#979000'>0</font>; col <font color='#5555FF'>&lt;</font> num_cols; col<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      r <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_RED]<font face='Lucida Console'>)</font>;
      g <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_GREEN]<font face='Lucida Console'>)</font>;
      b <font color='#5555FF'>=</font> <font color='#BB00BB'>GETJSAMPLE</font><font face='Lucida Console'>(</font>inptr[RGB_BLUE]<font face='Lucida Console'>)</font>;
      inptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> RGB_PIXELSIZE;
      <font color='#009900'>/* Assume that MAXJSAMPLE+1 is a power of 2, so that the MOD
       * (modulo) operator is equivalent to the bitmask operator AND.
       */</font>
      outptr0[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>r <font color='#5555FF'>-</font> g <font color='#5555FF'>+</font> CENTERJSAMPLE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> MAXJSAMPLE<font face='Lucida Console'>)</font>;
      outptr1[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> g;
      outptr2[col] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>JSAMPLE<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>b <font color='#5555FF'>-</font> g <font color='#5555FF'>+</font> CENTERJSAMPLE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> MAXJSAMPLE<font face='Lucida Console'>)</font>;
    <b>}</b>
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Convert some rows of samples to the JPEG colorspace.
 * This version handles grayscale output with no conversion.
 * The source can be either plain grayscale or YCC (since Y == gray).
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='grayscale_convert'></a>grayscale_convert</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo,
		   JSAMPARRAY input_buf, JSAMPIMAGE output_buf,
		   JDIMENSION output_row, <font color='#0000FF'><u>int</u></font> num_rows<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#0000FF'>register</font> JSAMPROW inptr;
  <font color='#0000FF'>register</font> JSAMPROW outptr;
  <font color='#0000FF'>register</font> JDIMENSION count;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> instride <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components;
  JDIMENSION num_cols <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width;

  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>num_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    inptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>input_buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr <font color='#5555FF'>=</font> output_buf[<font color='#979000'>0</font>][output_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>];
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>count <font color='#5555FF'>=</font> num_cols; count <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; count<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
      <font color='#5555FF'>*</font>outptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr;	<font color='#009900'>/* don't need GETJSAMPLE() here */</font>
      inptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> instride;
    <b>}</b>
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Convert some rows of samples to the JPEG colorspace.
 * No colorspace conversion, but change from interleaved
 * to separate-planes representation.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='rgb_convert'></a>rgb_convert</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo,
	     JSAMPARRAY input_buf, JSAMPIMAGE output_buf,
	     JDIMENSION output_row, <font color='#0000FF'><u>int</u></font> num_rows<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#0000FF'>register</font> JSAMPROW inptr;
  <font color='#0000FF'>register</font> JSAMPROW outptr0, outptr1, outptr2;
  <font color='#0000FF'>register</font> JDIMENSION col;
  JDIMENSION num_cols <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width;

  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>num_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    inptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>input_buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    outptr0 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>0</font>][output_row];
    outptr1 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>1</font>][output_row];
    outptr2 <font color='#5555FF'>=</font> output_buf[<font color='#979000'>2</font>][output_row];
    output_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>col <font color='#5555FF'>=</font> <font color='#979000'>0</font>; col <font color='#5555FF'>&lt;</font> num_cols; col<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      <font color='#009900'>/* We can dispense with GETJSAMPLE() here */</font>
      outptr0[col] <font color='#5555FF'>=</font> inptr[RGB_RED];
      outptr1[col] <font color='#5555FF'>=</font> inptr[RGB_GREEN];
      outptr2[col] <font color='#5555FF'>=</font> inptr[RGB_BLUE];
      inptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> RGB_PIXELSIZE;
    <b>}</b>
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Convert some rows of samples to the JPEG colorspace.
 * This version handles multi-component colorspaces without conversion.
 * We assume input_components == num_components.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='null_convert'></a>null_convert</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo,
	      JSAMPARRAY input_buf, JSAMPIMAGE output_buf,
	      JDIMENSION output_row, <font color='#0000FF'><u>int</u></font> num_rows<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#0000FF'>register</font> JSAMPROW inptr;
  <font color='#0000FF'>register</font> JSAMPROW outptr;
  <font color='#0000FF'>register</font> JDIMENSION count;
  <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> num_comps <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components;
  JDIMENSION num_cols <font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image_width;
  <font color='#0000FF'><u>int</u></font> ci;

  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>num_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#009900'>/* It seems fastest to make a separate pass for each component. */</font>
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>ci <font color='#5555FF'>=</font> <font color='#979000'>0</font>; ci <font color='#5555FF'>&lt;</font> num_comps; ci<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
      inptr <font color='#5555FF'>=</font> input_buf[<font color='#979000'>0</font>] <font color='#5555FF'>+</font> ci;
      outptr <font color='#5555FF'>=</font> output_buf[ci][output_row];
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>count <font color='#5555FF'>=</font> num_cols; count <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; count<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <b>{</b>
	<font color='#5555FF'>*</font>outptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inptr;	<font color='#009900'>/* don't need GETJSAMPLE() here */</font>
	inptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> num_comps;
      <b>}</b>
    <b>}</b>
    input_buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
    output_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
  <b>}</b>
<b>}</b>


<font color='#009900'>/*
 * Empty method for start_pass.
 */</font>

<b><a name='METHODDEF'></a>METHODDEF</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='null_method'></a>null_method</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#009900'>/* no work needed */</font>
<b>}</b>


<font color='#009900'>/*
 * Module initialization routine for input colorspace conversion.
 */</font>

<b><a name='GLOBAL'></a>GLOBAL</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b><a name='jinit_color_converter'></a>jinit_color_converter</b> <font face='Lucida Console'>(</font>j_compress_ptr cinfo<font face='Lucida Console'>)</font>
<b>{</b>
  my_cconvert_ptr cconvert;

  cconvert <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>my_cconvert_ptr<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mem<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alloc_small<font face='Lucida Console'>)</font>
    <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>j_common_ptr<font face='Lucida Console'>)</font> cinfo, JPOOL_IMAGE, <font color='#BB00BB'>SIZEOF</font><font face='Lucida Console'>(</font>my_color_converter<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
  cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>cconvert <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub;
  <font color='#009900'>/* set start_pass to null method until we find out differently */</font>
  cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.start_pass <font color='#5555FF'>=</font> null_method;

  <font color='#009900'>/* Make sure input_components agrees with in_color_space */</font>
  <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space<font face='Lucida Console'>)</font> <b>{</b>
  <font color='#0000FF'>case</font> JCS_GRAYSCALE:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_IN_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> JCS_RGB:
  <font color='#0000FF'>case</font> JCS_BG_RGB:
<font color='#0000FF'>#if</font> RGB_PIXELSIZE <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> RGB_PIXELSIZE<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_IN_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;
<font color='#0000FF'>#endif</font> <font color='#009900'>/* else share code with YCbCr */</font>

  <font color='#0000FF'>case</font> JCS_YCbCr:
  <font color='#0000FF'>case</font> JCS_BG_YCC:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_IN_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> JCS_CMYK:
  <font color='#0000FF'>case</font> JCS_YCCK:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_IN_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>default</font>:			<font color='#009900'>/* JCS_UNKNOWN can be anything */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_IN_COLORSPACE<font face='Lucida Console'>)</font>;
  <b>}</b>

  <font color='#009900'>/* Support color transform only for RGB colorspaces */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_transform <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>jpeg_color_space <font color='#5555FF'>!</font><font color='#5555FF'>=</font> JCS_RGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>jpeg_color_space <font color='#5555FF'>!</font><font color='#5555FF'>=</font> JCS_BG_RGB<font face='Lucida Console'>)</font>
    <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;

  <font color='#009900'>/* Check num_components, set conversion method based on requested space */</font>
  <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>jpeg_color_space<font face='Lucida Console'>)</font> <b>{</b>
  <font color='#0000FF'>case</font> JCS_GRAYSCALE:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_J_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> JCS_GRAYSCALE:
    <font color='#0000FF'>case</font> JCS_YCbCr:
    <font color='#0000FF'>case</font> JCS_BG_YCC:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> grayscale_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> JCS_RGB:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.start_pass <font color='#5555FF'>=</font> rgb_ycc_start;
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> rgb_gray_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> JCS_RGB:
  <font color='#0000FF'>case</font> JCS_BG_RGB:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_J_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space <font color='#5555FF'>!</font><font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>jpeg_color_space<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_transform<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> JCT_NONE:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> rgb_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> JCT_SUBTRACT_GREEN:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> rgb_rgb1_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> JCS_YCbCr:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_J_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> JCS_RGB:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.start_pass <font color='#5555FF'>=</font> rgb_ycc_start;
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> rgb_ycc_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> JCS_YCbCr:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> null_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> JCS_BG_YCC:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_J_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> JCS_RGB:
      <font color='#009900'>/* For conversion from normal RGB input to BG_YCC representation,
       * the Cb/Cr values are first computed as usual, and then
       * quantized further after DCT processing by a factor of
       * 2 in reference to the nominal quantization factor.
       */</font>
      <font color='#009900'>/* need quantization scale by factor of 2 after DCT */</font>
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comp_info[<font color='#979000'>1</font>].component_needed <font color='#5555FF'>=</font> TRUE;
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comp_info[<font color='#979000'>2</font>].component_needed <font color='#5555FF'>=</font> TRUE;
      <font color='#009900'>/* compute normal YCC first */</font>
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.start_pass <font color='#5555FF'>=</font> rgb_ycc_start;
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> rgb_ycc_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> JCS_YCbCr:
      <font color='#009900'>/* need quantization scale by factor of 2 after DCT */</font>
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comp_info[<font color='#979000'>1</font>].component_needed <font color='#5555FF'>=</font> TRUE;
      cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comp_info[<font color='#979000'>2</font>].component_needed <font color='#5555FF'>=</font> TRUE;
      <font color='#009900'>/*FALLTHROUGH*/</font>
    <font color='#0000FF'>case</font> JCS_BG_YCC:
      <font color='#009900'>/* Pass through for BG_YCC input */</font>
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> null_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> JCS_CMYK:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_J_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space <font color='#5555FF'>!</font><font color='#5555FF'>=</font> JCS_CMYK<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> null_convert;
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>case</font> JCS_YCCK:
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_BAD_J_COLORSPACE<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> JCS_CMYK:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.start_pass <font color='#5555FF'>=</font> rgb_ycc_start;
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> cmyk_ycck_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> JCS_YCCK:
      cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> null_convert;
      <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>break</font>;

  <font color='#0000FF'>default</font>:			<font color='#009900'>/* allow null conversion of JCS_UNKNOWN */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>jpeg_color_space <font color='#5555FF'>!</font><font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>in_color_space <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
	cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_components <font color='#5555FF'>!</font><font color='#5555FF'>=</font> cinfo<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_components<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>ERREXIT</font><font face='Lucida Console'>(</font>cinfo, JERR_CONVERSION_NOTIMPL<font face='Lucida Console'>)</font>;
    cconvert<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pub.color_convert <font color='#5555FF'>=</font> null_convert;
  <b>}</b>
<b>}</b>

</pre></body></html>