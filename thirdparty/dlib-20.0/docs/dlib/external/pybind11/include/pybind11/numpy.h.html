<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - numpy.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>/*
    pybind11/numpy.h: Basic NumPy support, vectorize() wrapper

    Copyright (c) 2016 Wenzel Jakob &lt;wenzel.jakob@epfl.ch&gt;

    All rights reserved. Use of this source code is governed by a
    BSD-style license that can be found in the LICENSE file.
*/</font>

<font color='#0000FF'>#pragma</font> once

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pybind11.h.html'>pybind11.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='detail/common.h.html'>detail/common.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='complex.h.html'>complex.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='gil_safe_call_once.h.html'>gil_safe_call_once.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pytypes.h.html'>pytypes.h</a>"

<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>algorithm<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>cstdint<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>cstdlib<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>cstring<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>functional<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>numeric<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>sstream<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>string<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>type_traits<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>typeindex<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>utility<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>vector<font color='#5555FF'>&gt;</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PYBIND11_NUMPY_1_ONLY<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PYBIND11_INTERNAL_NUMPY_1_ONLY_DETECTED<font face='Lucida Console'>)</font>
#    error PYBIND11_NUMPY_1_ONLY must be defined before any pybind11 header is included.
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* This will be true on all flat address space platforms and allows us to reduce the
   whole npy_intp / ssize_t / Py_intptr_t business down to just ssize_t for all size
   and dimension types (e.g. shape, strides, indexing), instead of inflicting this
   upon the library user.
   Note that NumPy 2 now uses ssize_t for `npy_intp` to simplify this. */</font>
<b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>::pybind11::ssize_t<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Py_intptr_t<font face='Lucida Console'>)</font>, "<font color='#CC0000'>ssize_t != Py_intptr_t</font>"<font face='Lucida Console'>)</font>;
<b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font>std::is_signed<font color='#5555FF'>&lt;</font>Py_intptr_t<font color='#5555FF'>&gt;</font>::value, "<font color='#CC0000'>Py_intptr_t must be signed</font>"<font face='Lucida Console'>)</font>;
<font color='#009900'>// We now can reinterpret_cast between py::ssize_t and Py_intptr_t (MSVC + PyPy cares)
</font>
<b><a name='PYBIND11_NAMESPACE_BEGIN'></a>PYBIND11_NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>PYBIND11_NAMESPACE<font face='Lucida Console'>)</font>

<b><a name='PYBIND11_WARNING_DISABLE_MSVC'></a>PYBIND11_WARNING_DISABLE_MSVC</b><font face='Lucida Console'>(</font><font color='#979000'>4127</font><font face='Lucida Console'>)</font>

<font color='#0000FF'>class</font> <b><a name='dtype'></a>dtype</b>; <font color='#009900'>// Forward declaration
</font><font color='#0000FF'>class</font> <b><a name='array'></a>array</b>; <font color='#009900'>// Forward declaration
</font>
<b><a name='PYBIND11_NAMESPACE_BEGIN'></a>PYBIND11_NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='handle_type_name'></a>handle_type_name</b><font color='#5555FF'>&lt;</font>dtype<font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.dtype</font>"<font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='handle_type_name'></a>handle_type_name</b><font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.ndarray</font>"<font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> type, <font color='#0000FF'>typename</font> SFINAE <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b>;

<font color='#009900'>/* NumPy 1 proxy (always includes legacy fields) */</font>
<font color='#0000FF'>struct</font> <b><a name='PyArrayDescr1_Proxy'></a>PyArrayDescr1_Proxy</b> <b>{</b>
    PyObject_HEAD
    PyObject <font color='#5555FF'>*</font>typeobj;
    <font color='#0000FF'><u>char</u></font> kind;
    <font color='#0000FF'><u>char</u></font> type;
    <font color='#0000FF'><u>char</u></font> byteorder;
    <font color='#0000FF'><u>char</u></font> flags;
    <font color='#0000FF'><u>int</u></font> type_num;
    <font color='#0000FF'><u>int</u></font> elsize;
    <font color='#0000FF'><u>int</u></font> alignment;
    <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>subarray;
    PyObject <font color='#5555FF'>*</font>fields;
    PyObject <font color='#5555FF'>*</font>names;
<b>}</b>;

<font color='#0000FF'>#ifndef</font> PYBIND11_NUMPY_1_ONLY
<font color='#0000FF'>struct</font> <b><a name='PyArrayDescr_Proxy'></a>PyArrayDescr_Proxy</b> <b>{</b>
    PyObject_HEAD
    PyObject <font color='#5555FF'>*</font>typeobj;
    <font color='#0000FF'><u>char</u></font> kind;
    <font color='#0000FF'><u>char</u></font> type;
    <font color='#0000FF'><u>char</u></font> byteorder;
    <font color='#0000FF'><u>char</u></font> _former_flags;
    <font color='#0000FF'><u>int</u></font> type_num;
    <font color='#009900'>/* Additional fields are NumPy version specific. */</font>
<b>}</b>;
<font color='#0000FF'>#else</font>
<font color='#009900'>/* NumPy 1.x only, we can expose all fields */</font>
<font color='#0000FF'>using</font> PyArrayDescr_Proxy <font color='#5555FF'>=</font> PyArrayDescr1_Proxy;
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* NumPy 2 proxy, including legacy fields */</font>
<font color='#0000FF'>struct</font> <b><a name='PyArrayDescr2_Proxy'></a>PyArrayDescr2_Proxy</b> <b>{</b>
    PyObject_HEAD
    PyObject <font color='#5555FF'>*</font>typeobj;
    <font color='#0000FF'><u>char</u></font> kind;
    <font color='#0000FF'><u>char</u></font> type;
    <font color='#0000FF'><u>char</u></font> byteorder;
    <font color='#0000FF'><u>char</u></font> _former_flags;
    <font color='#0000FF'><u>int</u></font> type_num;
    std::uint64_t flags;
    ssize_t elsize;
    ssize_t alignment;
    PyObject <font color='#5555FF'>*</font>metadata;
    Py_hash_t hash;
    <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>reserved_null[<font color='#979000'>2</font>];
    <font color='#009900'>/* The following fields only exist if 0 &lt;= type_num &lt; 2056 */</font>
    <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>subarray;
    PyObject <font color='#5555FF'>*</font>fields;
    PyObject <font color='#5555FF'>*</font>names;
<b>}</b>;

<font color='#0000FF'>struct</font> <b><a name='PyArray_Proxy'></a>PyArray_Proxy</b> <b>{</b>
    PyObject_HEAD
    <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>data;
    <font color='#0000FF'><u>int</u></font> nd;
    ssize_t <font color='#5555FF'>*</font>dimensions;
    ssize_t <font color='#5555FF'>*</font>strides;
    PyObject <font color='#5555FF'>*</font>base;
    PyObject <font color='#5555FF'>*</font>descr;
    <font color='#0000FF'><u>int</u></font> flags;
<b>}</b>;

<font color='#0000FF'>struct</font> <b><a name='PyVoidScalarObject_Proxy'></a>PyVoidScalarObject_Proxy</b> <b>{</b>
    PyObject_VAR_HEAD <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>obval;
    PyArrayDescr_Proxy <font color='#5555FF'>*</font>descr;
    <font color='#0000FF'><u>int</u></font> flags;
    PyObject <font color='#5555FF'>*</font>base;
<b>}</b>;

<font color='#0000FF'>struct</font> <b><a name='numpy_type_info'></a>numpy_type_info</b> <b>{</b>
    PyObject <font color='#5555FF'>*</font>dtype_ptr;
    std::string format_str;
<b>}</b>;

<font color='#0000FF'>struct</font> <b><a name='numpy_internals'></a>numpy_internals</b> <b>{</b>
    std::unordered_map<font color='#5555FF'>&lt;</font>std::type_index, numpy_type_info<font color='#5555FF'>&gt;</font> registered_dtypes;

    numpy_type_info <font color='#5555FF'>*</font><b><a name='get_type_info'></a>get_type_info</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>&amp;</font>tinfo, <font color='#0000FF'><u>bool</u></font> throw_if_missing <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> it <font color='#5555FF'>=</font> registered_dtypes.<font color='#BB00BB'>find</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>type_index</font><font face='Lucida Console'>(</font>tinfo<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>!</font><font color='#5555FF'>=</font> registered_dtypes.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font>it<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>throw_if_missing<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>string</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>NumPy type info missing for </font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> tinfo.<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> nullptr;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    numpy_type_info <font color='#5555FF'>*</font><b><a name='get_type_info'></a>get_type_info</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>bool</u></font> throw_if_missing <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>get_type_info</font><font face='Lucida Console'>(</font><font color='#0000FF'>typeid</font><font face='Lucida Console'>(</font><font color='#0000FF'>typename</font> std::remove_cv<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font face='Lucida Console'>)</font>, throw_if_missing<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

PYBIND11_NOINLINE <font color='#0000FF'><u>void</u></font> <b><a name='load_numpy_internals'></a>load_numpy_internals</b><font face='Lucida Console'>(</font>numpy_internals <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    ptr <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>get_or_create_shared_data<font color='#5555FF'>&lt;</font>numpy_internals<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>_numpy_internals</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> numpy_internals <font color='#5555FF'>&amp;</font><b><a name='get_numpy_internals'></a>get_numpy_internals</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>static</font> numpy_internals <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>load_numpy_internals</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>return</font> <font color='#5555FF'>*</font>ptr;
<b>}</b>

PYBIND11_NOINLINE module_ <b><a name='import_numpy_core_submodule'></a>import_numpy_core_submodule</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>submodule_name<font face='Lucida Console'>)</font> <b>{</b>
    module_ numpy <font color='#5555FF'>=</font> module_::<font color='#BB00BB'>import</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy</font>"<font face='Lucida Console'>)</font>;
    str version_string <font color='#5555FF'>=</font> numpy.<font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>__version__</font>"<font face='Lucida Console'>)</font>;

    module_ numpy_lib <font color='#5555FF'>=</font> module_::<font color='#BB00BB'>import</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.lib</font>"<font face='Lucida Console'>)</font>;
    object numpy_version <font color='#5555FF'>=</font> numpy_lib.<font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>NumpyVersion</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>version_string<font face='Lucida Console'>)</font>;
    <font color='#0000FF'><u>int</u></font> major_version <font color='#5555FF'>=</font> numpy_version.<font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>major</font>"<font face='Lucida Console'>)</font>.cast<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>major_version <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>throw</font> std::<font color='#BB00BB'>runtime_error</font><font face='Lucida Console'>(</font>
            "<font color='#CC0000'>This extension was built with PYBIND11_NUMPY_1_ONLY defined, </font>"
            "<font color='#CC0000'>but NumPy 2 is used in this process. For NumPy2 compatibility, </font>"
            "<font color='#CC0000'>this extension needs to be rebuilt without the PYBIND11_NUMPY_1_ONLY define.</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>
<font color='#0000FF'>#endif</font>
    <font color='#009900'>/* `numpy.core` was renamed to `numpy._core` in NumPy 2.0 as it officially
        became a private module. */</font>
    std::string numpy_core_path <font color='#5555FF'>=</font> major_version <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> ? "<font color='#CC0000'>numpy._core</font>" : "<font color='#CC0000'>numpy.core</font>";
    <font color='#0000FF'>return</font> module_::<font color='#BB00BB'>import</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>numpy_core_path <font color='#5555FF'>+</font> "<font color='#CC0000'>.</font>" <font color='#5555FF'>+</font> submodule_name<font face='Lucida Console'>)</font>.<font color='#BB00BB'>c_str</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='same_size'></a>same_size</b> <b>{</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> U<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>using</font> as <font color='#5555FF'>=</font> bool_constant<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>U<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Concrete<font color='#5555FF'>&gt;</font>
constexpr <font color='#0000FF'><u>int</u></font> <b><a name='platform_lookup'></a>platform_lookup</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>;
<b>}</b>

<font color='#009900'>// Lookup a type according to its size, and return a value corresponding to the NumPy typenum.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Concrete, <font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font>... Ts, <font color='#0000FF'>typename</font>... Ints<font color='#5555FF'>&gt;</font>
constexpr <font color='#0000FF'><u>int</u></font> <b><a name='platform_lookup'></a>platform_lookup</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font> I, Ints... Is<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Concrete<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> ? I : platform_lookup<font color='#5555FF'>&lt;</font>Concrete, Ts...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>Is...<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>struct</font> <b><a name='npy_api'></a>npy_api</b> <b>{</b>
    <font color='#0000FF'>enum</font> <b><a name='constants'></a>constants</b> <b>{</b>
        NPY_ARRAY_C_CONTIGUOUS_ <font color='#5555FF'>=</font> <font color='#979000'>0x0001</font>,
        NPY_ARRAY_F_CONTIGUOUS_ <font color='#5555FF'>=</font> <font color='#979000'>0x0002</font>,
        NPY_ARRAY_OWNDATA_ <font color='#5555FF'>=</font> <font color='#979000'>0x0004</font>,
        NPY_ARRAY_FORCECAST_ <font color='#5555FF'>=</font> <font color='#979000'>0x0010</font>,
        NPY_ARRAY_ENSUREARRAY_ <font color='#5555FF'>=</font> <font color='#979000'>0x0040</font>,
        NPY_ARRAY_ALIGNED_ <font color='#5555FF'>=</font> <font color='#979000'>0x0100</font>,
        NPY_ARRAY_WRITEABLE_ <font color='#5555FF'>=</font> <font color='#979000'>0x0400</font>,
        NPY_BOOL_ <font color='#5555FF'>=</font> <font color='#979000'>0</font>,
        NPY_BYTE_,
        NPY_UBYTE_,
        NPY_SHORT_,
        NPY_USHORT_,
        NPY_INT_,
        NPY_UINT_,
        NPY_LONG_,
        NPY_ULONG_,
        NPY_LONGLONG_,
        NPY_ULONGLONG_,
        NPY_FLOAT_,
        NPY_DOUBLE_,
        NPY_LONGDOUBLE_,
        NPY_CFLOAT_,
        NPY_CDOUBLE_,
        NPY_CLONGDOUBLE_,
        NPY_OBJECT_ <font color='#5555FF'>=</font> <font color='#979000'>17</font>,
        NPY_STRING_,
        NPY_UNICODE_,
        NPY_VOID_,
        <font color='#009900'>// Platform-dependent normalization
</font>        NPY_INT8_ <font color='#5555FF'>=</font> NPY_BYTE_,
        NPY_UINT8_ <font color='#5555FF'>=</font> NPY_UBYTE_,
        NPY_INT16_ <font color='#5555FF'>=</font> NPY_SHORT_,
        NPY_UINT16_ <font color='#5555FF'>=</font> NPY_USHORT_,
        <font color='#009900'>// `npy_common.h` defines the integer aliases. In order, it checks:
</font>        <font color='#009900'>// NPY_BITSOF_LONG, NPY_BITSOF_LONGLONG, NPY_BITSOF_INT, NPY_BITSOF_SHORT, NPY_BITSOF_CHAR
</font>        <font color='#009900'>// and assigns the alias to the first matching size, so we should check in this order.
</font>        NPY_INT32_
        <font color='#5555FF'>=</font> platform_lookup<font color='#5555FF'>&lt;</font>std::int32_t, <font color='#0000FF'><u>long</u></font>, <font color='#0000FF'><u>int</u></font>, <font color='#0000FF'><u>short</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>NPY_LONG_, NPY_INT_, NPY_SHORT_<font face='Lucida Console'>)</font>,
        NPY_UINT32_ <font color='#5555FF'>=</font> platform_lookup<font color='#5555FF'>&lt;</font>std::uint32_t, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font>, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font>, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
            NPY_ULONG_, NPY_UINT_, NPY_USHORT_<font face='Lucida Console'>)</font>,
        NPY_INT64_
        <font color='#5555FF'>=</font> platform_lookup<font color='#5555FF'>&lt;</font>std::int64_t, <font color='#0000FF'><u>long</u></font>, <font color='#0000FF'><u>long</u></font> <font color='#0000FF'><u>long</u></font>, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>NPY_LONG_, NPY_LONGLONG_, NPY_INT_<font face='Lucida Console'>)</font>,
        NPY_UINT64_
        <font color='#5555FF'>=</font> platform_lookup<font color='#5555FF'>&lt;</font>std::uint64_t, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font>, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font> <font color='#0000FF'><u>long</u></font>, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
            NPY_ULONG_, NPY_ULONGLONG_, NPY_UINT_<font face='Lucida Console'>)</font>,
    <b>}</b>;

    <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> PyArray_RUNTIME_VERSION_;

    <font color='#0000FF'>struct</font> <b><a name='PyArray_Dims'></a>PyArray_Dims</b> <b>{</b>
        Py_intptr_t <font color='#5555FF'>*</font>ptr;
        <font color='#0000FF'><u>int</u></font> len;
    <b>}</b>;

    <font color='#0000FF'>static</font> npy_api <font color='#5555FF'>&amp;</font><b><a name='get'></a>get</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        PYBIND11_CONSTINIT <font color='#0000FF'>static</font> gil_safe_call_once_and_store<font color='#5555FF'>&lt;</font>npy_api<font color='#5555FF'>&gt;</font> storage;
        <font color='#0000FF'>return</font> storage.<font color='#BB00BB'>call_once_and_store_result</font><font face='Lucida Console'>(</font>lookup<font face='Lucida Console'>)</font>.<font color='#BB00BB'>get_stored</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'><u>bool</u></font> <b><a name='PyArray_Check_'></a>PyArray_Check_</b><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>obj<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>PyObject_TypeCheck</font><font face='Lucida Console'>(</font>obj, PyArray_Type_<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <b>}</b>
    <font color='#0000FF'><u>bool</u></font> <b><a name='PyArrayDescr_Check_'></a>PyArrayDescr_Check_</b><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>obj<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>PyObject_TypeCheck</font><font face='Lucida Console'>(</font>obj, PyArrayDescr_Type_<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <b>}</b>

    <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_GetNDArrayCFeatureVersion_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_DescrFromType_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_NewFromDescr_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyTypeObject <font color='#5555FF'>*</font>,
                                       PyObject <font color='#5555FF'>*</font>,
                                       <font color='#0000FF'><u>int</u></font>,
                                       Py_intptr_t <font color='#0000FF'>const</font> <font color='#5555FF'>*</font>,
                                       Py_intptr_t <font color='#0000FF'>const</font> <font color='#5555FF'>*</font>,
                                       <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>,
                                       <font color='#0000FF'><u>int</u></font>,
                                       PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
    <font color='#009900'>// Unused. Not removed because that affects ABI of the class.
</font>    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_DescrNewFromType_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'><u>int</u></font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_CopyInto_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_NewCopy_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>;
    PyTypeObject <font color='#5555FF'>*</font>PyArray_Type_;
    PyTypeObject <font color='#5555FF'>*</font>PyVoidArrType_Type_;
    PyTypeObject <font color='#5555FF'>*</font>PyArrayDescr_Type_;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_DescrFromScalar_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_FromAny_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyObject <font color='#5555FF'>*</font>, <font color='#0000FF'><u>int</u></font>, <font color='#0000FF'><u>int</u></font>, <font color='#0000FF'><u>int</u></font>, PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'><u>int</u></font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_DescrConverter_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyObject <font color='#5555FF'>*</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'><u>bool</u></font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_EquivTypes_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
    <font color='#0000FF'><u>int</u></font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_GetArrayParamsFromObject_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>,
                                             PyObject <font color='#5555FF'>*</font>,
                                             <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font>,
                                             PyObject <font color='#5555FF'>*</font><font color='#5555FF'>*</font>,
                                             <font color='#0000FF'><u>int</u></font> <font color='#5555FF'>*</font>,
                                             Py_intptr_t <font color='#5555FF'>*</font>,
                                             PyObject <font color='#5555FF'>*</font><font color='#5555FF'>*</font>,
                                             PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_Squeeze_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
    <font color='#009900'>// Unused. Not removed because that affects ABI of the class.
</font>    <font color='#0000FF'><u>int</u></font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_SetBaseObject_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_Resize_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyArray_Dims <font color='#5555FF'>*</font>, <font color='#0000FF'><u>int</u></font>, <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_Newshape_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyArray_Dims <font color='#5555FF'>*</font>, <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>;
    PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>PyArray_View_<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, PyObject <font color='#5555FF'>*</font>, PyObject <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>private</font>:
    <font color='#0000FF'>enum</font> <b><a name='functions'></a>functions</b> <b>{</b>
        API_PyArray_GetNDArrayCFeatureVersion <font color='#5555FF'>=</font> <font color='#979000'>211</font>,
        API_PyArray_Type <font color='#5555FF'>=</font> <font color='#979000'>2</font>,
        API_PyArrayDescr_Type <font color='#5555FF'>=</font> <font color='#979000'>3</font>,
        API_PyVoidArrType_Type <font color='#5555FF'>=</font> <font color='#979000'>39</font>,
        API_PyArray_DescrFromType <font color='#5555FF'>=</font> <font color='#979000'>45</font>,
        API_PyArray_DescrFromScalar <font color='#5555FF'>=</font> <font color='#979000'>57</font>,
        API_PyArray_FromAny <font color='#5555FF'>=</font> <font color='#979000'>69</font>,
        API_PyArray_Resize <font color='#5555FF'>=</font> <font color='#979000'>80</font>,
        <font color='#009900'>// CopyInto was slot 82 and 50 was effectively an alias. NumPy 2 removed 82.
</font>        API_PyArray_CopyInto <font color='#5555FF'>=</font> <font color='#979000'>50</font>,
        API_PyArray_NewCopy <font color='#5555FF'>=</font> <font color='#979000'>85</font>,
        API_PyArray_NewFromDescr <font color='#5555FF'>=</font> <font color='#979000'>94</font>,
        API_PyArray_DescrNewFromType <font color='#5555FF'>=</font> <font color='#979000'>96</font>,
        API_PyArray_Newshape <font color='#5555FF'>=</font> <font color='#979000'>135</font>,
        API_PyArray_Squeeze <font color='#5555FF'>=</font> <font color='#979000'>136</font>,
        API_PyArray_View <font color='#5555FF'>=</font> <font color='#979000'>137</font>,
        API_PyArray_DescrConverter <font color='#5555FF'>=</font> <font color='#979000'>174</font>,
        API_PyArray_EquivTypes <font color='#5555FF'>=</font> <font color='#979000'>182</font>,
<font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
        API_PyArray_GetArrayParamsFromObject <font color='#5555FF'>=</font> <font color='#979000'>278</font>,
<font color='#0000FF'>#endif</font>
        API_PyArray_SetBaseObject <font color='#5555FF'>=</font> <font color='#979000'>282</font>
    <b>}</b>;

    <font color='#0000FF'>static</font> npy_api <b><a name='lookup'></a>lookup</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        module_ m <font color='#5555FF'>=</font> detail::<font color='#BB00BB'>import_numpy_core_submodule</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>multiarray</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> c <font color='#5555FF'>=</font> m.<font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>_ARRAY_API</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>*</font>api_ptr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>PyCapsule_GetPointer</font><font face='Lucida Console'>(</font>c.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, nullptr<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>api_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>raise_from</font><font face='Lucida Console'>(</font>PyExc_SystemError, "<font color='#CC0000'>FAILURE obtaining numpy _ARRAY_API pointer.</font>"<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        npy_api api;
<font color='#0000FF'>#define</font> DECL_NPY_API<font face='Lucida Console'>(</font>Func<font face='Lucida Console'>)</font> api.Func##_ <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>decltype<font face='Lucida Console'>(</font>api.Func##_<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> api_ptr[API_##Func];
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_GetNDArrayCFeatureVersion<font face='Lucida Console'>)</font>;
        api.PyArray_RUNTIME_VERSION_ <font color='#5555FF'>=</font> api.<font color='#BB00BB'>PyArray_GetNDArrayCFeatureVersion_</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>api.PyArray_RUNTIME_VERSION_ <font color='#5555FF'>&lt;</font> <font color='#979000'>0x7</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11 numpy support requires numpy &gt;= 1.7.0</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_Type<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyVoidArrType_Type<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArrayDescr_Type<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_DescrFromType<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_DescrFromScalar<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_FromAny<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_Resize<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_CopyInto<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_NewCopy<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_NewFromDescr<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_DescrNewFromType<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_Newshape<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_Squeeze<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_View<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_DescrConverter<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_EquivTypes<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_GetArrayParamsFromObject<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
        <font color='#BB00BB'>DECL_NPY_API</font><font face='Lucida Console'>(</font>PyArray_SetBaseObject<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#undef</font> DECL_NPY_API
        <font color='#0000FF'>return</font> api;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>inline</font> PyArray_Proxy <font color='#5555FF'>*</font><b><a name='array_proxy'></a>array_proxy</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>PyArray_Proxy <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>; <b>}</b>

<font color='#0000FF'>inline</font> <font color='#0000FF'>const</font> PyArray_Proxy <font color='#5555FF'>*</font><b><a name='array_proxy'></a>array_proxy</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> PyArray_Proxy <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> PyArrayDescr_Proxy <font color='#5555FF'>*</font><b><a name='array_descriptor_proxy'></a>array_descriptor_proxy</b><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>PyArrayDescr_Proxy <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> <font color='#0000FF'>const</font> PyArrayDescr_Proxy <font color='#5555FF'>*</font><b><a name='array_descriptor_proxy'></a>array_descriptor_proxy</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> PyObject <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> PyArrayDescr_Proxy <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> <font color='#0000FF'>const</font> PyArrayDescr1_Proxy <font color='#5555FF'>*</font><b><a name='array_descriptor1_proxy'></a>array_descriptor1_proxy</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> PyObject <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> PyArrayDescr1_Proxy <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> <font color='#0000FF'>const</font> PyArrayDescr2_Proxy <font color='#5555FF'>*</font><b><a name='array_descriptor2_proxy'></a>array_descriptor2_proxy</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> PyObject <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> PyArrayDescr2_Proxy <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>inline</font> <font color='#0000FF'><u>bool</u></font> <b><a name='check_flags'></a>check_flags</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr, <font color='#0000FF'><u>int</u></font> flag<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>flag <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> flag<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='is_std_array'></a>is_std_array</b> : std::false_type <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='is_std_array'></a>is_std_array</b><font color='#5555FF'>&lt;</font>std::array<font color='#5555FF'>&lt;</font>T, N<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : std::true_type <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='is_complex'></a>is_complex</b> : std::false_type <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='is_complex'></a>is_complex</b><font color='#5555FF'>&lt;</font>std::complex<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : std::true_type <b>{</b><b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='array_info_scalar'></a>array_info_scalar</b> <b>{</b>
    <font color='#0000FF'>using</font> type <font color='#5555FF'>=</font> T;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> is_array <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> is_empty <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> extents <font color='#5555FF'>=</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'></font>"<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='append_extents'></a>append_extents</b><font face='Lucida Console'>(</font>list <font color='#5555FF'>&amp;</font> <font color='#009900'>/* shape */</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>
<b>}</b>;
<font color='#009900'>// Computes underlying type and a comma-separated list of extents for array
</font><font color='#009900'>// types (any mix of std::array and built-in arrays). An array of char is
</font><font color='#009900'>// treated as scalar because it gets special handling.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='array_info'></a>array_info</b> : array_info_scalar<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='array_info'></a>array_info</b><font color='#5555FF'>&lt;</font>std::array<font color='#5555FF'>&lt;</font>T, N<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>using</font> type <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> is_array <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> is_empty <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>N <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::is_empty;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>size_t</u></font> extent <font color='#5555FF'>=</font> N;

    <font color='#009900'>// appends the extents to shape
</font>    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='append_extents'></a>append_extents</b><font face='Lucida Console'>(</font>list <font color='#5555FF'>&amp;</font>shape<font face='Lucida Console'>)</font> <b>{</b>
        shape.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>N<font face='Lucida Console'>)</font>;
        array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>append_extents</font><font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> extents <font color='#5555FF'>=</font> const_name<font color='#5555FF'>&lt;</font>array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::is_array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
        ::pybind11::detail::<font color='#BB00BB'>concat</font><font face='Lucida Console'>(</font>const_name<font color='#5555FF'>&lt;</font>N<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::extents<font face='Lucida Console'>)</font>, const_name<font color='#5555FF'>&lt;</font>N<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;
<font color='#009900'>// For numpy we have special handling for arrays of characters, so we don't include
</font><font color='#009900'>// the size in the array extents.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='array_info'></a>array_info</b><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>[N]<font color='#5555FF'>&gt;</font> : array_info_scalar<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>[N]<font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='array_info'></a>array_info</b><font color='#5555FF'>&lt;</font>std::array<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>, N<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> : array_info_scalar<font color='#5555FF'>&lt;</font>std::array<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>, N<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='array_info'></a>array_info</b><font color='#5555FF'>&lt;</font>T[N]<font color='#5555FF'>&gt;</font> : array_info<font color='#5555FF'>&lt;</font>std::array<font color='#5555FF'>&lt;</font>T, N<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> remove_all_extents_t <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> is_pod_struct
    <font color='#5555FF'>=</font> all_of<font color='#5555FF'>&lt;</font>std::is_standard_layout<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>, <font color='#009900'>// since we're accessing directly in memory
</font>                                         <font color='#009900'>// we need a standard layout type
</font><font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>__GLIBCXX__<font face='Lucida Console'>)</font>                                                                          \
    <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>__GLIBCXX__ <font color='#5555FF'>&lt;</font> <font color='#979000'>20150422</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> __GLIBCXX__ <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>20150426</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> __GLIBCXX__ <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>20150623</font>              \
        <font color='#5555FF'>|</font><font color='#5555FF'>|</font> __GLIBCXX__ <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>20150626</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> __GLIBCXX__ <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>20160803</font><font face='Lucida Console'>)</font>
             <font color='#009900'>// libstdc++ &lt; 5 (including versions 4.8.5, 4.9.3 and 4.9.4 which were released after
</font>             <font color='#009900'>// 5) don't implement is_trivially_copyable, so approximate it
</font>             std::is_trivially_destructible<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>,
             satisfies_any_of<font color='#5555FF'>&lt;</font>T, std::has_trivial_copy_constructor, std::has_trivial_copy_assign<font color='#5555FF'>&gt;</font>,
<font color='#0000FF'>#else</font>
             std::is_trivially_copyable<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>,
<font color='#0000FF'>#endif</font>
             satisfies_none_of<font color='#5555FF'>&lt;</font>T,
                               std::is_reference,
                               std::is_array,
                               is_std_array,
                               std::is_arithmetic,
                               is_complex,
                               std::is_enum<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// Replacement for std::is_pod (deprecated in C++20)
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> is_pod <font color='#5555FF'>=</font> all_of<font color='#5555FF'>&lt;</font>std::is_standard_layout<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>, std::is_trivial<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>ssize_t Dim <font color='#5555FF'>=</font> <font color='#979000'>0</font>, <font color='#0000FF'>typename</font> Strides<font color='#5555FF'>&gt;</font>
ssize_t <b><a name='byte_offset_unsafe'></a>byte_offset_unsafe</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> Strides <font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>ssize_t Dim <font color='#5555FF'>=</font> <font color='#979000'>0</font>, <font color='#0000FF'>typename</font> Strides, <font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
ssize_t <b><a name='byte_offset_unsafe'></a>byte_offset_unsafe</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> Strides <font color='#5555FF'>&amp;</font>strides, ssize_t i, Ix... index<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> i <font color='#5555FF'>*</font> strides[Dim] <font color='#5555FF'>+</font> byte_offset_unsafe<font color='#5555FF'>&lt;</font>Dim <font color='#5555FF'>+</font> <font color='#979000'>1</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>strides, index...<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/**
 * Proxy class providing unsafe, unchecked const access to array data.  This is constructed through
 * the `unchecked&lt;T, N&gt;()` method of `array` or the `unchecked&lt;N&gt;()` method of `array_t&lt;T&gt;`. `Dims`
 * will be -1 for dimensions determined at runtime.
 */</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, ssize_t Dims<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='unchecked_reference'></a>unchecked_reference</b> <b>{</b>
<font color='#0000FF'>protected</font>:
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> Dynamic <font color='#5555FF'>=</font> Dims <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font>;
    <font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>data_;
    <font color='#009900'>// Storing the shape &amp; strides in local variables (i.e. these arrays) allows the compiler to
</font>    <font color='#009900'>// make large performance gains on big, nested loops, but requires compile-time dimensions
</font>    conditional_t<font color='#5555FF'>&lt;</font>Dynamic, <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font>, std::array<font color='#5555FF'>&lt;</font>ssize_t, <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> Dims<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shape_, strides_;
    <font color='#0000FF'>const</font> ssize_t dims_;

    <font color='#0000FF'>friend</font> <font color='#0000FF'>class</font> <b><a name='pybind11'></a>pybind11</b>::array;
    <font color='#009900'>// Constructor for compile-time dimensions:
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font> Dyn <font color='#5555FF'>=</font> Dynamic<font color='#5555FF'>&gt;</font>
    <b><a name='unchecked_reference'></a>unchecked_reference</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>data,
                        <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font>shape,
                        <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font>strides,
                        enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>Dyn, ssize_t<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font>
        : data_<b>{</b><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>data<font face='Lucida Console'>)</font><b>}</b>, dims_<b>{</b>Dims<b>}</b> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> dims_; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <b>{</b>
            shape_[i] <font color='#5555FF'>=</font> shape[i];
            strides_[i] <font color='#5555FF'>=</font> strides[i];
        <b>}</b>
    <b>}</b>
    <font color='#009900'>// Constructor for runtime dimensions:
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font> Dyn <font color='#5555FF'>=</font> Dynamic<font color='#5555FF'>&gt;</font>
    <b><a name='unchecked_reference'></a>unchecked_reference</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>data,
                        <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font>shape,
                        <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font>strides,
                        enable_if_t<font color='#5555FF'>&lt;</font>Dyn, ssize_t<font color='#5555FF'>&gt;</font> dims<font face='Lucida Console'>)</font>
        : data_<b>{</b><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>data<font face='Lucida Console'>)</font><b>}</b>, shape_<b>{</b>shape<b>}</b>, strides_<b>{</b>strides<b>}</b>,
          dims_<b>{</b>dims<b>}</b> <b>{</b><b>}</b>

<font color='#0000FF'>public</font>:
    <font color='#009900'>/**
     * Unchecked const reference access to data at the given indices.  For a compile-time known
     * number of dimensions, this requires the correct number of arguments; for run-time
     * dimensionality, this is not checked (and so is up to the caller to use safely).
     */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> T <font color='#5555FF'>&amp;</font><b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>ssize_t<b>{</b><font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Ix<font face='Lucida Console'>)</font><b>}</b> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Dims <font color='#5555FF'>|</font><font color='#5555FF'>|</font> Dynamic,
                      "<font color='#CC0000'>Invalid number of indices for unchecked array reference</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>data_
                                            <font color='#5555FF'>+</font> <font color='#BB00BB'>byte_offset_unsafe</font><font face='Lucida Console'>(</font>strides_, <font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#009900'>/**
     * Unchecked const reference access to data; this operator only participates if the reference
     * is to a 1-dimensional array.  When present, this is exactly equivalent to `obj(index)`.
     */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>ssize_t D <font color='#5555FF'>=</font> Dims, <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> enable_if_t<font color='#5555FF'>&lt;</font>D <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> Dynamic<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> T <font color='#5555FF'>&amp;</font><b><a name='operator'></a>operator</b>[]<font face='Lucida Console'>(</font>ssize_t index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>operator</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Pointer access to the data at the given indices.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><b><a name='data'></a>data</b><font face='Lucida Console'>(</font>Ix... ix<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#5555FF'>&amp;</font><font color='#0000FF'>operator</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>ix<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Returns the item size, i.e. sizeof(T)
</font>    constexpr <font color='#0000FF'>static</font> ssize_t <b><a name='itemsize'></a>itemsize</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#009900'>/// Returns the shape (i.e. size) of dimension `dim`
</font>    ssize_t <b><a name='shape'></a>shape</b><font face='Lucida Console'>(</font>ssize_t dim<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> shape_[<font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> dim]; <b>}</b>

    <font color='#009900'>/// Returns the number of dimensions of the array
</font>    ssize_t <b><a name='ndim'></a>ndim</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> dims_; <b>}</b>

    <font color='#009900'>/// Returns the total number of elements in the referenced array, i.e. the product of the
</font>    <font color='#009900'>/// shapes
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font> Dyn <font color='#5555FF'>=</font> Dynamic<font color='#5555FF'>&gt;</font>
    enable_if_t<font color='#5555FF'>&lt;</font><font color='#5555FF'>!</font>Dyn, ssize_t<font color='#5555FF'>&gt;</font> <b><a name='size'></a>size</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> std::<font color='#BB00BB'>accumulate</font><font face='Lucida Console'>(</font>
            shape_.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, shape_.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font face='Lucida Console'>(</font>ssize_t<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, std::multiplies<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font> Dyn <font color='#5555FF'>=</font> Dynamic<font color='#5555FF'>&gt;</font>
    enable_if_t<font color='#5555FF'>&lt;</font>Dyn, ssize_t<font color='#5555FF'>&gt;</font> <b><a name='size'></a>size</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> std::<font color='#BB00BB'>accumulate</font><font face='Lucida Console'>(</font>shape_, shape_ <font color='#5555FF'>+</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font face='Lucida Console'>(</font>ssize_t<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, std::multiplies<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Returns the total number of bytes used by the referenced data.  Note that the actual span
</font>    <font color='#009900'>/// in memory may be larger if the referenced array has non-contiguous strides (e.g. for a
</font>    <font color='#009900'>/// slice).
</font>    ssize_t <b><a name='nbytes'></a>nbytes</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, ssize_t Dims<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='unchecked_mutable_reference'></a>unchecked_mutable_reference</b> : <font color='#0000FF'>public</font> unchecked_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>friend</font> <font color='#0000FF'>class</font> <b><a name='pybind11'></a>pybind11</b>::array;
    <font color='#0000FF'>using</font> ConstBase <font color='#5555FF'>=</font> unchecked_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>using</font> ConstBase::ConstBase;
    <font color='#0000FF'>using</font> ConstBase::Dynamic;

<font color='#0000FF'>public</font>:
    <font color='#009900'>// Bring in const-qualified versions from base class
</font>    <font color='#0000FF'>using</font> ConstBase::<b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>using</font> ConstBase::<b><a name='operator'></a>operator</b>[];

    <font color='#009900'>/// Mutable, unchecked access to data at the given indices.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    T <font color='#5555FF'>&amp;</font><b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>static_assert</font><font face='Lucida Console'>(</font>ssize_t<b>{</b><font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Ix<font face='Lucida Console'>)</font><b>}</b> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Dims <font color='#5555FF'>|</font><font color='#5555FF'>|</font> Dynamic,
                      "<font color='#CC0000'>Invalid number of indices for unchecked array reference</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font>T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ConstBase::<font color='#0000FF'>operator</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#009900'>/**
     * Mutable, unchecked access data at the given index; this operator only participates if the
     * reference is to a 1-dimensional array (or has runtime dimensions).  When present, this is
     * exactly equivalent to `obj(index)`.
     */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>ssize_t D <font color='#5555FF'>=</font> Dims, <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> enable_if_t<font color='#5555FF'>&lt;</font>D <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> Dynamic<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    T <font color='#5555FF'>&amp;</font><b><a name='operator'></a>operator</b>[]<font face='Lucida Console'>(</font>ssize_t index<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>operator</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Mutable pointer access to the data at the given indices.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    T <font color='#5555FF'>*</font><b><a name='mutable_data'></a>mutable_data</b><font face='Lucida Console'>(</font>Ix... ix<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#5555FF'>&amp;</font><font color='#0000FF'>operator</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>ix<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, ssize_t Dim<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>unchecked_reference<font color='#5555FF'>&lt;</font>T, Dim<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font>Dim <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> Dim <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#009900'>/* always fail */</font>,
                  "<font color='#CC0000'>unchecked array proxy object is not castable</font>"<font face='Lucida Console'>)</font>;
<b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, ssize_t Dim<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='type_caster'></a>type_caster</b><font color='#5555FF'>&lt;</font>unchecked_mutable_reference<font color='#5555FF'>&lt;</font>T, Dim<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : type_caster<font color='#5555FF'>&lt;</font>unchecked_reference<font color='#5555FF'>&lt;</font>T, Dim<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b><b>}</b>;

<b><a name='PYBIND11_NAMESPACE_END'></a>PYBIND11_NAMESPACE_END</b><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#0000FF'>class</font> <b><a name='dtype'></a>dtype</b> : <font color='#0000FF'>public</font> object <b>{</b>
<font color='#0000FF'>public</font>:
    <b><a name='PYBIND11_OBJECT_DEFAULT'></a>PYBIND11_OBJECT_DEFAULT</b><font face='Lucida Console'>(</font>dtype, object, detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.PyArrayDescr_Check_<font face='Lucida Console'>)</font>

    <font color='#0000FF'>explicit</font> <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> buffer_info <font color='#5555FF'>&amp;</font>info<font face='Lucida Console'>)</font> <b>{</b>
        dtype <font color='#BB00BB'>descr</font><font face='Lucida Console'>(</font><font color='#BB00BB'>_dtype_from_pep3118</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>pybind11::<font color='#BB00BB'>str</font><font face='Lucida Console'>(</font>info.format<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#009900'>// If info.itemsize == 0, use the value calculated from the format string
</font>        m_ptr <font color='#5555FF'>=</font> descr.<font color='#BB00BB'>strip_padding</font><font face='Lucida Console'>(</font>info.itemsize <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> ? info.itemsize : descr.<font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                    .<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
                    .<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> pybind11::str <font color='#5555FF'>&amp;</font>format<font face='Lucida Console'>)</font> : dtype<font face='Lucida Console'>(</font>from_args<font face='Lucida Console'>(</font>format<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::string <font color='#5555FF'>&amp;</font>format<font face='Lucida Console'>)</font> : dtype<font face='Lucida Console'>(</font>pybind11::str<font face='Lucida Console'>(</font>format<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>format<font face='Lucida Console'>)</font> : dtype<font face='Lucida Console'>(</font>pybind11::str<font face='Lucida Console'>(</font>format<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font>list names, list formats, list offsets, ssize_t itemsize<font face='Lucida Console'>)</font> <b>{</b>
        dict args;
        args["<font color='#CC0000'>names</font>"] <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>names<font face='Lucida Console'>)</font>;
        args["<font color='#CC0000'>formats</font>"] <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>formats<font face='Lucida Console'>)</font>;
        args["<font color='#CC0000'>offsets</font>"] <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>offsets<font face='Lucida Console'>)</font>;
        args["<font color='#CC0000'>itemsize</font>"] <font color='#5555FF'>=</font> pybind11::<font color='#BB00BB'>int_</font><font face='Lucida Console'>(</font>itemsize<font face='Lucida Console'>)</font>;
        m_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>from_args</font><font face='Lucida Console'>(</font>args<font face='Lucida Console'>)</font>.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Return dtype for the given typenum (one of the NPY_TYPES).
</font>    <font color='#009900'>/// https://numpy.org/devdocs/reference/c-api/array.html#c.PyArray_DescrFromType
</font>    <font color='#0000FF'>explicit</font> <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font> typenum<font face='Lucida Console'>)</font>
        : object<font face='Lucida Console'>(</font>detail::npy_api::get<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.PyArray_DescrFromType_<font face='Lucida Console'>(</font>typenum<font face='Lucida Console'>)</font>, stolen_t<b>{</b><b>}</b><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>m_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    <font color='#009900'>/// This is essentially the same as calling numpy.dtype(args) in Python.
</font>    <font color='#0000FF'>static</font> dtype <b><a name='from_args'></a>from_args</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> object <font color='#5555FF'>&amp;</font>args<font face='Lucida Console'>)</font> <b>{</b>
        PyObject <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>PyArray_DescrConverter_</font><font face='Lucida Console'>(</font>args.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#5555FF'>&amp;</font>ptr<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#5555FF'>!</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> reinterpret_steal<font color='#5555FF'>&lt;</font>dtype<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Return dtype associated with a C++ type.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>static</font> dtype <b><a name='of'></a>of</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> detail::npy_format_descriptor<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::remove_cv<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Size of the data type in bytes.
</font><font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
    ssize_t <b><a name='itemsize'></a>itemsize</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>elsize; <b>}</b>
<font color='#0000FF'>#else</font>
    ssize_t <b><a name='itemsize'></a>itemsize</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.PyArray_RUNTIME_VERSION_ <font color='#5555FF'>&lt;</font> <font color='#979000'>0x12</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor1_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>elsize;
        <b>}</b>
        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor2_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>elsize;
    <b>}</b>
<font color='#0000FF'>#endif</font>

    <font color='#009900'>/// Returns true for structured data types.
</font><font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
    <font color='#0000FF'><u>bool</u></font> <b><a name='has_fields'></a>has_fields</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>names <font color='#5555FF'>!</font><font color='#5555FF'>=</font> nullptr; <b>}</b>
<font color='#0000FF'>#else</font>
    <font color='#0000FF'><u>bool</u></font> <b><a name='has_fields'></a>has_fields</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.PyArray_RUNTIME_VERSION_ <font color='#5555FF'>&lt;</font> <font color='#979000'>0x12</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor1_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>names <font color='#5555FF'>!</font><font color='#5555FF'>=</font> nullptr;
        <b>}</b>
        <font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>proxy <font color='#5555FF'>=</font> detail::<font color='#BB00BB'>array_descriptor2_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>proxy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type_num <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> proxy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type_num <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>2056</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> proxy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>names <font color='#5555FF'>!</font><font color='#5555FF'>=</font> nullptr;
    <b>}</b>
<font color='#0000FF'>#endif</font>

    <font color='#009900'>/// Single-character code for dtype's kind.
</font>    <font color='#009900'>/// For example, floating point types are 'f' and integral types are 'i'.
</font>    <font color='#0000FF'><u>char</u></font> <b><a name='kind'></a>kind</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>kind; <b>}</b>

    <font color='#009900'>/// Single-character for dtype's type.
</font>    <font color='#009900'>/// For example, ``float`` is 'f', ``double`` 'd', ``int`` 'i', and ``long`` 'l'.
</font>    <font color='#0000FF'><u>char</u></font> <b><a name='char_'></a>char_</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#009900'>// Note: The signature, `dtype::char_` follows the naming of NumPy's
</font>        <font color='#009900'>// public Python API (i.e., ``dtype.char``), rather than its internal
</font>        <font color='#009900'>// C API (``PyArray_Descr::type``).
</font>        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type;
    <b>}</b>

    <font color='#009900'>/// type number of dtype.
</font>    <font color='#0000FF'><u>int</u></font> <b><a name='num'></a>num</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#009900'>// Note: The signature, `dtype::num` follows the naming of NumPy's public
</font>        <font color='#009900'>// Python API (i.e., ``dtype.num``), rather than its internal
</font>        <font color='#009900'>// C API (``PyArray_Descr::type_num``).
</font>        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>type_num;
    <b>}</b>

    <font color='#009900'>/// Single character for byteorder
</font>    <font color='#0000FF'><u>char</u></font> <b><a name='byteorder'></a>byteorder</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>byteorder; <b>}</b>

<font color='#009900'>/// Alignment of the data type
</font><font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
    <font color='#0000FF'><u>int</u></font> <b><a name='alignment'></a>alignment</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alignment; <b>}</b>
<font color='#0000FF'>#else</font>
    ssize_t <b><a name='alignment'></a>alignment</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.PyArray_RUNTIME_VERSION_ <font color='#5555FF'>&lt;</font> <font color='#979000'>0x12</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor1_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alignment;
        <b>}</b>
        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor2_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alignment;
    <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/// Flags for the array descriptor
</font><font color='#0000FF'>#ifdef</font> PYBIND11_NUMPY_1_ONLY
    <font color='#0000FF'><u>char</u></font> <b><a name='flags'></a>flags</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags; <b>}</b>
<font color='#0000FF'>#else</font>
    std::uint64_t <b><a name='flags'></a>flags</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.PyArray_RUNTIME_VERSION_ <font color='#5555FF'>&lt;</font> <font color='#979000'>0x12</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font><font face='Lucida Console'>)</font> detail::<font color='#BB00BB'>array_descriptor1_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags;
        <b>}</b>
        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_descriptor2_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags;
    <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>private</font>:
    <font color='#0000FF'>static</font> object <font color='#5555FF'>&amp;</font><b><a name='_dtype_from_pep3118'></a>_dtype_from_pep3118</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        PYBIND11_CONSTINIT <font color='#0000FF'>static</font> gil_safe_call_once_and_store<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font> storage;
        <font color='#0000FF'>return</font> storage
            .<font color='#BB00BB'>call_once_and_store_result</font><font face='Lucida Console'>(</font>[]<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>import_numpy_core_submodule</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>_internal</font>"<font face='Lucida Console'>)</font>
                    .<font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>_dtype_from_pep3118</font>"<font face='Lucida Console'>)</font>;
            <b>}</b><font face='Lucida Console'>)</font>
            .<font color='#BB00BB'>get_stored</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    dtype <b><a name='strip_padding'></a>strip_padding</b><font face='Lucida Console'>(</font>ssize_t itemsize<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>// Recursively strip all void fields with empty names that are generated for
</font>        <font color='#009900'>// padding fields (as of NumPy v1.11).
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>has_fields</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>this</font>;
        <b>}</b>

        <font color='#0000FF'>struct</font> <b><a name='field_descr'></a>field_descr</b> <b>{</b>
            pybind11::str name;
            object format;
            pybind11::int_ offset;
            <b><a name='field_descr'></a>field_descr</b><font face='Lucida Console'>(</font>pybind11::str <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>name, object <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>format, pybind11::int_ <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>offset<font face='Lucida Console'>)</font>
                : name<b>{</b>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>name<font face='Lucida Console'>)</font><b>}</b>, format<b>{</b>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>format<font face='Lucida Console'>)</font><b>}</b>, offset<b>{</b>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>offset<font face='Lucida Console'>)</font><b>}</b> <b>{</b><b>}</b>;
        <b>}</b>;
        <font color='#0000FF'>auto</font> field_dict <font color='#5555FF'>=</font> <font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>fields</font>"<font face='Lucida Console'>)</font>.cast<font color='#5555FF'>&lt;</font>dict<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        std::vector<font color='#5555FF'>&lt;</font>field_descr<font color='#5555FF'>&gt;</font> field_descriptors;
        field_descriptors.<font color='#BB00BB'>reserve</font><font face='Lucida Console'>(</font>field_dict.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> field : field_dict.<font color='#BB00BB'>attr</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>items</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>auto</font> spec <font color='#5555FF'>=</font> field.cast<font color='#5555FF'>&lt;</font>tuple<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> spec[<font color='#979000'>0</font>].cast<font color='#5555FF'>&lt;</font>pybind11::str<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>auto</font> spec_fo <font color='#5555FF'>=</font> spec[<font color='#979000'>1</font>].cast<font color='#5555FF'>&lt;</font>tuple<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>auto</font> format <font color='#5555FF'>=</font> spec_fo[<font color='#979000'>0</font>].cast<font color='#5555FF'>&lt;</font>dtype<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>auto</font> offset <font color='#5555FF'>=</font> spec_fo[<font color='#979000'>1</font>].cast<font color='#5555FF'>&lt;</font>pybind11::int_<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#BB00BB'>len</font><font face='Lucida Console'>(</font>name<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>u<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> format.<font color='#BB00BB'>kind</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>V</font>'<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>continue</font>;
            <b>}</b>
            field_descriptors.<font color='#BB00BB'>emplace_back</font><font face='Lucida Console'>(</font>
                std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>name<font face='Lucida Console'>)</font>, format.<font color='#BB00BB'>strip_padding</font><font face='Lucida Console'>(</font>format.<font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>offset<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>

        std::<font color='#BB00BB'>sort</font><font face='Lucida Console'>(</font>field_descriptors.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                  field_descriptors.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                  []<font face='Lucida Console'>(</font><font color='#0000FF'>const</font> field_descr <font color='#5555FF'>&amp;</font>a, <font color='#0000FF'>const</font> field_descr <font color='#5555FF'>&amp;</font>b<font face='Lucida Console'>)</font> <b>{</b>
                      <font color='#0000FF'>return</font> a.offset.cast<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> b.offset.cast<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                  <b>}</b><font face='Lucida Console'>)</font>;

        list names, formats, offsets;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>descr : field_descriptors<font face='Lucida Console'>)</font> <b>{</b>
            names.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>descr.name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            formats.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>descr.format<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            offsets.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>descr.offset<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>names<font face='Lucida Console'>)</font>, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>formats<font face='Lucida Console'>)</font>, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>offsets<font face='Lucida Console'>)</font>, itemsize<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>class</font> <b><a name='array'></a>array</b> : <font color='#0000FF'>public</font> buffer <b>{</b>
<font color='#0000FF'>public</font>:
    <b><a name='PYBIND11_OBJECT_CVT'></a>PYBIND11_OBJECT_CVT</b><font face='Lucida Console'>(</font>array, buffer, detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.PyArray_Check_, raw_array<font face='Lucida Console'>)</font>

    <font color='#0000FF'>enum</font> <b>{</b>
        c_style <font color='#5555FF'>=</font> detail::npy_api::NPY_ARRAY_C_CONTIGUOUS_,
        f_style <font color='#5555FF'>=</font> detail::npy_api::NPY_ARRAY_F_CONTIGUOUS_,
        forcecast <font color='#5555FF'>=</font> detail::npy_api::NPY_ARRAY_FORCECAST_
    <b>}</b>;

    <b><a name='array'></a>array</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : array<font face='Lucida Console'>(</font><font color='#979000'>0</font>, <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>nullptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>using</font> ShapeContainer <font color='#5555FF'>=</font> detail::any_container<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>using</font> StridesContainer <font color='#5555FF'>=</font> detail::any_container<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font>;

    <font color='#009900'>// Constructs an array taking shape/strides from arbitrary container types
</font>    <b><a name='array'></a>array</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> pybind11::dtype <font color='#5555FF'>&amp;</font>dt,
          ShapeContainer shape,
          StridesContainer strides,
          <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr,
          handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strides<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>empty</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#5555FF'>*</font>strides <font color='#5555FF'>=</font> detail::<font color='#BB00BB'>c_strides</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>shape, dt.<font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#0000FF'>auto</font> ndim <font color='#5555FF'>=</font> shape<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ndim <font color='#5555FF'>!</font><font color='#5555FF'>=</font> strides<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>NumPy: shape ndim doesn't match strides ndim</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>auto</font> descr <font color='#5555FF'>=</font> dt;

        <font color='#0000FF'><u>int</u></font> flags <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>base <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>isinstance<font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>base<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#009900'>/* Copy flags from base (except ownership bit) */</font>
                flags <font color='#5555FF'>=</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>base<font face='Lucida Console'>)</font>.<font color='#BB00BB'>flags</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>&amp;</font> ~detail::npy_api::NPY_ARRAY_OWNDATA_;
            <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
                <font color='#009900'>/* Writable by default, easy to downgrade later on if needed */</font>
                flags <font color='#5555FF'>=</font> detail::npy_api::NPY_ARRAY_WRITEABLE_;
            <b>}</b>
        <b>}</b>

        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>api <font color='#5555FF'>=</font> detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> tmp <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>api.<font color='#BB00BB'>PyArray_NewFromDescr_</font><font face='Lucida Console'>(</font>
            api.PyArray_Type_,
            descr.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
            <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> ndim,
            <font color='#009900'>// Use reinterpret_cast for PyPy on Windows (remove if fixed, checked on 7.3.1)
</font>            <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>Py_intptr_t <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>shape<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
            <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>Py_intptr_t <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>strides<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
            <font color='#0000FF'>const_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font>,
            flags,
            nullptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>tmp<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>base<font face='Lucida Console'>)</font> <b>{</b>
                api.<font color='#BB00BB'>PyArray_SetBaseObject_</font><font face='Lucida Console'>(</font>tmp.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, base.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
                tmp <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
                    api.<font color='#BB00BB'>PyArray_NewCopy_</font><font face='Lucida Console'>(</font>tmp.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#5555FF'>-</font><font color='#979000'>1</font> <font color='#009900'>/* any order */</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <b>}</b>
        <b>}</b>
        m_ptr <font color='#5555FF'>=</font> tmp.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <b><a name='array'></a>array</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> pybind11::dtype <font color='#5555FF'>&amp;</font>dt,
          ShapeContainer shape,
          <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr,
          handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font>dt, std::move<font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>, <b>{</b><b>}</b>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T,
              <font color='#0000FF'>typename</font>
              <font color='#5555FF'>=</font> detail::enable_if_t<font color='#5555FF'>&lt;</font>std::is_integral<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font>, T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    <b><a name='array'></a>array</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> pybind11::dtype <font color='#5555FF'>&amp;</font>dt, T count, <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font>dt, <b>{</b><b>{</b>count<b>}</b><b>}</b>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <b><a name='array'></a>array</b><font face='Lucida Console'>(</font>ShapeContainer shape, StridesContainer strides, <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>ptr, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font>pybind11::dtype::of<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, std::move<font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>, std::move<font face='Lucida Console'>(</font>strides<font face='Lucida Console'>)</font>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <b><a name='array'></a>array</b><font face='Lucida Console'>(</font>ShapeContainer shape, <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>ptr, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font>std::move<font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>, <b>{</b><b>}</b>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>explicit</font> <b><a name='array'></a>array</b><font face='Lucida Console'>(</font>ssize_t count, <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>ptr, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font><b>{</b>count<b>}</b>, <b>{</b><b>}</b>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='array'></a>array</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> buffer_info <font color='#5555FF'>&amp;</font>info, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font>pybind11::dtype<font face='Lucida Console'>(</font>info<font face='Lucida Console'>)</font>, info.shape, info.strides, info.ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#009900'>/// Array descriptor (dtype)
</font>    pybind11::dtype <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>pybind11::dtype<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>descr<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Total number of elements
</font>    ssize_t <b><a name='size'></a>size</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> std::<font color='#BB00BB'>accumulate</font><font face='Lucida Console'>(</font><font color='#BB00BB'>shape</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>shape</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font face='Lucida Console'>(</font>ssize_t<font face='Lucida Console'>)</font> <font color='#979000'>1</font>, std::multiplies<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Byte size of a single element
</font>    ssize_t <b><a name='itemsize'></a>itemsize</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#009900'>/// Total number of bytes
</font>    ssize_t <b><a name='nbytes'></a>nbytes</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#009900'>/// Number of dimensions
</font>    ssize_t <b><a name='ndim'></a>ndim</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nd; <b>}</b>

    <font color='#009900'>/// Base object
</font>    object <b><a name='base'></a>base</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>base<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#009900'>/// Dimensions of the array
</font>    <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font><b><a name='shape'></a>shape</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>dimensions; <b>}</b>

    <font color='#009900'>/// Dimension along a given axis
</font>    ssize_t <b><a name='shape'></a>shape</b><font face='Lucida Console'>(</font>ssize_t dim<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dim <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fail_dim_check</font><font face='Lucida Console'>(</font>dim, "<font color='#CC0000'>invalid axis</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>shape</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>[dim];
    <b>}</b>

    <font color='#009900'>/// Strides of the array
</font>    <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font><b><a name='strides'></a>strides</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strides; <b>}</b>

    <font color='#009900'>/// Stride along a given axis
</font>    ssize_t <b><a name='strides'></a>strides</b><font face='Lucida Console'>(</font>ssize_t dim<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dim <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fail_dim_check</font><font face='Lucida Console'>(</font>dim, "<font color='#CC0000'>invalid axis</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>strides</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>[dim];
    <b>}</b>

    <font color='#009900'>/// Return the NumPy array flags
</font>    <font color='#0000FF'><u>int</u></font> <b><a name='flags'></a>flags</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags; <b>}</b>

    <font color='#009900'>/// If set, the array is writeable (otherwise the buffer is read-only)
</font>    <font color='#0000FF'><u>bool</u></font> <b><a name='writeable'></a>writeable</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>check_flags</font><font face='Lucida Console'>(</font>m_ptr, detail::npy_api::NPY_ARRAY_WRITEABLE_<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// If set, the array owns the data (will be freed when the array is deleted)
</font>    <font color='#0000FF'><u>bool</u></font> <b><a name='owndata'></a>owndata</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>check_flags</font><font face='Lucida Console'>(</font>m_ptr, detail::npy_api::NPY_ARRAY_OWNDATA_<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Pointer to the contained data. If index is not provided, points to the
</font>    <font color='#009900'>/// beginning of the buffer. May throw if the index would lead to out of bounds access.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><b><a name='data'></a>data</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>data <font color='#5555FF'>+</font> <font color='#BB00BB'>offset_at</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Mutable pointer to the contained data. If index is not provided, points to the
</font>    <font color='#009900'>/// beginning of the buffer. May throw if the index would lead to out of bounds access.
</font>    <font color='#009900'>/// May throw if the array is not writeable.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><b><a name='mutable_data'></a>mutable_data</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>check_writeable</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>data <font color='#5555FF'>+</font> <font color='#BB00BB'>offset_at</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Byte offset from beginning of the array to a given index (full or partial).
</font>    <font color='#009900'>/// May throw if the index would lead to out of bounds access.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    ssize_t <b><a name='offset_at'></a>offset_at</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ssize_t<font face='Lucida Console'>)</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fail_dim_check</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>, "<font color='#CC0000'>too many indices for an array</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>byte_offset</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
    <b>}</b>

    ssize_t <b><a name='offset_at'></a>offset_at</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <b>}</b>

    <font color='#009900'>/// Item count from beginning of the array to a given index (full or partial).
</font>    <font color='#009900'>/// May throw if the index would lead to out of bounds access.
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    ssize_t <b><a name='index_at'></a>index_at</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>offset_at</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/**
     * Returns a proxy object that provides access to the array's data without bounds or
     * dimensionality checking.  Will throw if the array is missing the `writeable` flag.  Use with
     * care: the array must not be destroyed or reshaped for the duration of the returned object,
     * and the caller must take care not to access invalid dimensions or dimension indices.
     */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, ssize_t Dims <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font color='#5555FF'>&gt;</font>
    detail::unchecked_mutable_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font> <b><a name='mutable_unchecked'></a>mutable_unchecked</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>Dims <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Dims<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> std::<font color='#BB00BB'>domain_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>array has incorrect number of dimensions: </font>"
                                    <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>; expected </font>"
                                    <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>Dims<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> detail::unchecked_mutable_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
            <font color='#BB00BB'>mutable_data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>shape</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>strides</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/**
     * Returns a proxy object that provides const access to the array's data without bounds or
     * dimensionality checking.  Unlike `mutable_unchecked()`, this does not require that the
     * underlying array have the `writable` flag.  Use with care: the array must not be destroyed
     * or reshaped for the duration of the returned object, and the caller must take care not to
     * access invalid dimensions or dimension indices.
     */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, ssize_t Dims <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font color='#5555FF'>&gt;</font>
    detail::unchecked_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font> <b><a name='unchecked'></a>unchecked</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>Dims <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Dims<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> std::<font color='#BB00BB'>domain_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>array has incorrect number of dimensions: </font>"
                                    <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'>; expected </font>"
                                    <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>Dims<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> detail::unchecked_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>shape</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>strides</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Return a new view with all of the dimensions of length 1 removed
</font>    array <b><a name='squeeze'></a>squeeze</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>api <font color='#5555FF'>=</font> detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> reinterpret_steal<font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>api.<font color='#BB00BB'>PyArray_Squeeze_</font><font face='Lucida Console'>(</font>m_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Resize array to given shape
</font>    <font color='#009900'>/// If refcheck is true and more that one reference exist to this array
</font>    <font color='#009900'>/// then resize will succeed only if it makes a reshape, i.e. original size doesn't change
</font>    <font color='#0000FF'><u>void</u></font> <b><a name='resize'></a>resize</b><font face='Lucida Console'>(</font>ShapeContainer new_shape, <font color='#0000FF'><u>bool</u></font> refcheck <font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font> <b>{</b>
        detail::npy_api::PyArray_Dims d
            <font color='#5555FF'>=</font> <b>{</b><font color='#009900'>// Use reinterpret_cast for PyPy on Windows (remove if fixed, checked on 7.3.1)
</font>               <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>Py_intptr_t <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>new_shape<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
               <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>(</font>new_shape<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><b>}</b>;
        <font color='#009900'>// try to resize, set ordering param to -1 cause it's not used anyway
</font>        <font color='#0000FF'>auto</font> new_array <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
            detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>PyArray_Resize_</font><font face='Lucida Console'>(</font>m_ptr, <font color='#5555FF'>&amp;</font>d, <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>(</font>refcheck<font face='Lucida Console'>)</font>, <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>new_array<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>isinstance<font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>new_array<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#5555FF'>*</font><font color='#0000FF'>this</font> <font color='#5555FF'>=</font> std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>new_array<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    <font color='#009900'>/// Optional `order` parameter omitted, to be added as needed.
</font>    array <b><a name='reshape'></a>reshape</b><font face='Lucida Console'>(</font>ShapeContainer new_shape<font face='Lucida Console'>)</font> <b>{</b>
        detail::npy_api::PyArray_Dims d
            <font color='#5555FF'>=</font> <b>{</b><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>Py_intptr_t <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>new_shape<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>(</font>new_shape<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><b>}</b>;
        <font color='#0000FF'>auto</font> new_array
            <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>PyArray_Newshape_</font><font face='Lucida Console'>(</font>m_ptr, <font color='#5555FF'>&amp;</font>d, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>new_array<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> new_array;
    <b>}</b>

    <font color='#009900'>/// Create a view of an array in a different data type.
</font>    <font color='#009900'>/// This function may fundamentally reinterpret the data in the array.
</font>    <font color='#009900'>/// It is the responsibility of the caller to ensure that this is safe.
</font>    <font color='#009900'>/// Only supports the `dtype` argument, the `type` argument is omitted,
</font>    <font color='#009900'>/// to be added as needed.
</font>    array <b><a name='view'></a>view</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::string <font color='#5555FF'>&amp;</font>dtype<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>api <font color='#5555FF'>=</font> detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> new_view <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>api.<font color='#BB00BB'>PyArray_View_</font><font face='Lucida Console'>(</font>
            m_ptr, dtype::<font color='#BB00BB'>from_args</font><font face='Lucida Console'>(</font>pybind11::<font color='#BB00BB'>str</font><font face='Lucida Console'>(</font>dtype<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, nullptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>new_view<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> new_view;
    <b>}</b>

    <font color='#009900'>/// Ensure that the argument is a NumPy array
</font>    <font color='#009900'>/// In case of an error, nullptr is returned and the Python error is cleared.
</font>    <font color='#0000FF'>static</font> array <b><a name='ensure'></a>ensure</b><font face='Lucida Console'>(</font>handle h, <font color='#0000FF'><u>int</u></font> ExtraFlags <font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> result <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>array<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>raw_array</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, ExtraFlags<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>result<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>PyErr_Clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> result;
    <b>}</b>

<font color='#0000FF'>protected</font>:
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>, <font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>friend</font> <font color='#0000FF'>struct</font> <b><a name='detail'></a>detail</b>::npy_format_descriptor;

    <font color='#0000FF'><u>void</u></font> <b><a name='fail_dim_check'></a>fail_dim_check</b><font face='Lucida Console'>(</font>ssize_t dim, <font color='#0000FF'>const</font> std::string <font color='#5555FF'>&amp;</font>msg<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>throw</font> <font color='#BB00BB'>index_error</font><font face='Lucida Console'>(</font>msg <font color='#5555FF'>+</font> "<font color='#CC0000'>: </font>" <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>dim<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> "<font color='#CC0000'> (ndim = </font>" <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                          <font color='#5555FF'>+</font> '<font color='#FF0000'>)</font>'<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    ssize_t <b><a name='byte_offset'></a>byte_offset</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#BB00BB'>check_dimensions</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>byte_offset_unsafe</font><font face='Lucida Console'>(</font><font color='#BB00BB'>strides</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'><u>void</u></font> <b><a name='check_writeable'></a>check_writeable</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>writeable</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> std::<font color='#BB00BB'>domain_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>array is not writeable</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='check_dimensions'></a>check_dimensions</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#BB00BB'>check_dimensions_impl</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>shape</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'><u>void</u></font> <b><a name='check_dimensions_impl'></a>check_dimensions_impl</b><font face='Lucida Console'>(</font>ssize_t, <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b><b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='check_dimensions_impl'></a>check_dimensions_impl</b><font face='Lucida Console'>(</font>ssize_t axis, <font color='#0000FF'>const</font> ssize_t <font color='#5555FF'>*</font>shape, ssize_t i, Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>shape<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>index_error</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>string</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>index </font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>i<font face='Lucida Console'>)</font>
                              <font color='#5555FF'>+</font> "<font color='#CC0000'> is out of bounds for axis </font>" <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>axis<font face='Lucida Console'>)</font>
                              <font color='#5555FF'>+</font> "<font color='#CC0000'> with size </font>" <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>shape<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#BB00BB'>check_dimensions_impl</font><font face='Lucida Console'>(</font>axis <font color='#5555FF'>+</font> <font color='#979000'>1</font>, shape <font color='#5555FF'>+</font> <font color='#979000'>1</font>, index...<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Create array from any object -- always returns a new reference
</font>    <font color='#0000FF'>static</font> PyObject <font color='#5555FF'>*</font><b><a name='raw_array'></a>raw_array</b><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>ptr, <font color='#0000FF'><u>int</u></font> ExtraFlags <font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>set_error</font><font face='Lucida Console'>(</font>PyExc_ValueError, "<font color='#CC0000'>cannot create a pybind11::array from a nullptr</font>"<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> nullptr;
        <b>}</b>
        <font color='#0000FF'>return</font> detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>PyArray_FromAny_</font><font face='Lucida Console'>(</font>
            ptr, nullptr, <font color='#979000'>0</font>, <font color='#979000'>0</font>, detail::npy_api::NPY_ARRAY_ENSUREARRAY_ <font color='#5555FF'>|</font> ExtraFlags, nullptr<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>int</u></font> ExtraFlags <font color='#5555FF'>=</font> array::forcecast<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='array_t'></a>array_t</b> : <font color='#0000FF'>public</font> array <b>{</b>
<font color='#0000FF'>private</font>:
    <font color='#0000FF'>struct</font> <b><a name='private_ctor'></a>private_ctor</b> <b>{</b><b>}</b>;
    <font color='#009900'>// Delegating constructor needed when both moving and accessing in the same constructor
</font>    <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font>private_ctor,
            ShapeContainer <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>shape,
            StridesContainer <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>strides,
            <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>ptr,
            handle base<font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font>std::move<font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>, std::move<font face='Lucida Console'>(</font>strides<font face='Lucida Console'>)</font>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

<font color='#0000FF'>public</font>:
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>detail::array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::is_array, "<font color='#CC0000'>Array types cannot be used with array_t</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>using</font> value_type <font color='#5555FF'>=</font> T;

    <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : array<font face='Lucida Console'>(</font><font color='#979000'>0</font>, <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>nullptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>
    <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font>handle h, borrowed_t<font face='Lucida Console'>)</font> : array<font face='Lucida Console'>(</font>h, borrowed_t<b>{</b><b>}</b><font face='Lucida Console'>)</font> <b>{</b><b>}</b>
    <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font>handle h, stolen_t<font face='Lucida Console'>)</font> : array<font face='Lucida Console'>(</font>h, stolen_t<b>{</b><b>}</b><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <b><a name='PYBIND11_DEPRECATED'></a>PYBIND11_DEPRECATED</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>Use array_t&lt;T&gt;::ensure() instead</font>"<font face='Lucida Console'>)</font>
    <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font>handle h, <font color='#0000FF'><u>bool</u></font> is_borrowed<font face='Lucida Console'>)</font> : array<font face='Lucida Console'>(</font>raw_array_t<font face='Lucida Console'>(</font>h.ptr<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, stolen_t<b>{</b><b>}</b><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>m_ptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>PyErr_Clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>is_borrowed<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>Py_XDECREF</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    <font color='#009900'>// NOLINTNEXTLINE(google-explicit-constructor)
</font>    <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> object <font color='#5555FF'>&amp;</font>o<font face='Lucida Console'>)</font> : array<font face='Lucida Console'>(</font>raw_array_t<font face='Lucida Console'>(</font>o.ptr<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, stolen_t<b>{</b><b>}</b><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>m_ptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>throw</font> <font color='#BB00BB'>error_already_set</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> buffer_info <font color='#5555FF'>&amp;</font>info, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> : array<font face='Lucida Console'>(</font>info, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font>ShapeContainer shape,
            StridesContainer strides,
            <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr,
            handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font>std::move<font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>, std::move<font face='Lucida Console'>(</font>strides<font face='Lucida Console'>)</font>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font>ShapeContainer shape, <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array_t<font face='Lucida Console'>(</font>private_ctor<b>{</b><b>}</b>,
                  std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>,
                  <font face='Lucida Console'>(</font>ExtraFlags <font color='#5555FF'>&amp;</font> f_style<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> ? detail::<font color='#BB00BB'>f_strides</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>shape, <font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                                              : detail::c_strides<font face='Lucida Console'>(</font><font color='#5555FF'>*</font>shape, itemsize<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
                  ptr,
                  base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <font color='#0000FF'>explicit</font> <b><a name='array_t'></a>array_t</b><font face='Lucida Console'>(</font>ssize_t count, <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> nullptr, handle base <font color='#5555FF'>=</font> <font color='#BB00BB'>handle</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        : array<font face='Lucida Console'>(</font><b>{</b>count<b>}</b>, <b>{</b><b>}</b>, ptr, base<font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    constexpr ssize_t <b><a name='itemsize'></a>itemsize</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    ssize_t <b><a name='index_at'></a>index_at</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>offset_at</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><b><a name='data'></a>data</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>array::<font color='#BB00BB'>data</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    T <font color='#5555FF'>*</font><b><a name='mutable_data'></a>mutable_data</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>array::<font color='#BB00BB'>mutable_data</font><font face='Lucida Console'>(</font>index...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>// Reference to element at a given index
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> T <font color='#5555FF'>&amp;</font><b><a name='at'></a>at</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ssize_t<font face='Lucida Console'>)</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fail_dim_check</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>, "<font color='#CC0000'>index dimension mismatch</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>const</font> T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>array::<font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                 <font color='#5555FF'>+</font> <font color='#BB00BB'>byte_offset</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>// Mutable reference to element at a given index
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font>... Ix<font color='#5555FF'>&gt;</font>
    T <font color='#5555FF'>&amp;</font><b><a name='mutable_at'></a>mutable_at</b><font face='Lucida Console'>(</font>Ix... index<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ssize_t<font face='Lucida Console'>)</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#BB00BB'>ndim</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fail_dim_check</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>, "<font color='#CC0000'>index dimension mismatch</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>array::<font color='#BB00BB'>mutable_data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                 <font color='#5555FF'>+</font> <font color='#BB00BB'>byte_offset</font><font face='Lucida Console'>(</font><font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#BB00BB'>itemsize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/**
     * Returns a proxy object that provides access to the array's data without bounds or
     * dimensionality checking.  Will throw if the array is missing the `writeable` flag.  Use with
     * care: the array must not be destroyed or reshaped for the duration of the returned object,
     * and the caller must take care not to access invalid dimensions or dimension indices.
     */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>ssize_t Dims <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font color='#5555FF'>&gt;</font>
    detail::unchecked_mutable_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font> <b><a name='mutable_unchecked'></a>mutable_unchecked</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <b>{</b>
        <font color='#0000FF'>return</font> array::mutable_unchecked<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/**
     * Returns a proxy object that provides const access to the array's data without bounds or
     * dimensionality checking.  Unlike `mutable_unchecked()`, this does not require that the
     * underlying array have the `writable` flag.  Use with care: the array must not be destroyed
     * or reshaped for the duration of the returned object, and the caller must take care not to
     * access invalid dimensions or dimension indices.
     */</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>ssize_t Dims <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font color='#5555FF'>&gt;</font>
    detail::unchecked_reference<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font> <b><a name='unchecked'></a>unchecked</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <font color='#5555FF'>&amp;</font> <b>{</b>
        <font color='#0000FF'>return</font> array::unchecked<font color='#5555FF'>&lt;</font>T, Dims<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/// Ensure that the argument is a NumPy array of the correct dtype (and if not, try to convert
</font>    <font color='#009900'>/// it).  In case of an error, nullptr is returned and the Python error is cleared.
</font>    <font color='#0000FF'>static</font> array_t <b><a name='ensure'></a>ensure</b><font face='Lucida Console'>(</font>handle h<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> result <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>array_t<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>raw_array_t</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>result<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>PyErr_Clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> result;
    <b>}</b>

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>bool</u></font> <b><a name='check_'></a>check_</b><font face='Lucida Console'>(</font>handle h<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>api <font color='#5555FF'>=</font> detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> api.<font color='#BB00BB'>PyArray_Check_</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> api.<font color='#BB00BB'>PyArray_EquivTypes_</font><font face='Lucida Console'>(</font>detail::<font color='#BB00BB'>array_proxy</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>descr,
                                          dtype::of<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> detail::<font color='#BB00BB'>check_flags</font><font face='Lucida Console'>(</font>h.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, ExtraFlags <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>array::c_style <font color='#5555FF'>|</font> array::f_style<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>protected</font>:
    <font color='#009900'>/// Create array from any object -- always returns a new reference
</font>    <font color='#0000FF'>static</font> PyObject <font color='#5555FF'>*</font><b><a name='raw_array_t'></a>raw_array_t</b><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>ptr<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nullptr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>set_error</font><font face='Lucida Console'>(</font>PyExc_ValueError, "<font color='#CC0000'>cannot create a pybind11::array_t from a nullptr</font>"<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> nullptr;
        <b>}</b>
        <font color='#0000FF'>return</font> detail::npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>PyArray_FromAny_</font><font face='Lucida Console'>(</font>ptr,
                                                       dtype::of<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                                                       <font color='#979000'>0</font>,
                                                       <font color='#979000'>0</font>,
                                                       detail::npy_api::NPY_ARRAY_ENSUREARRAY_
                                                           <font color='#5555FF'>|</font> ExtraFlags,
                                                       nullptr<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='format_descriptor'></a>format_descriptor</b><font color='#5555FF'>&lt;</font>T, detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::is_pod_struct<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> std::string <b><a name='format'></a>format</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> detail::npy_format_descriptor<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::remove_cv<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>format</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='format_descriptor'></a>format_descriptor</b><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>[N]<font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> std::string <b><a name='format'></a>format</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>N<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> '<font color='#FF0000'>s</font>'; <b>}</b>
<b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='format_descriptor'></a>format_descriptor</b><font color='#5555FF'>&lt;</font>std::array<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>, N<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> std::string <b><a name='format'></a>format</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>N<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> '<font color='#FF0000'>s</font>'; <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='format_descriptor'></a>format_descriptor</b><font color='#5555FF'>&lt;</font>T, detail::enable_if_t<font color='#5555FF'>&lt;</font>std::is_enum<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> std::string <b><a name='format'></a>format</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> format_descriptor<font color='#5555FF'>&lt;</font>
            <font color='#0000FF'>typename</font> std::remove_cv<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::underlying_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>format</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='format_descriptor'></a>format_descriptor</b><font color='#5555FF'>&lt;</font>T, detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::is_array<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> std::string <b><a name='format'></a>format</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>using</font> <font color='#0000FF'>namespace</font> detail;
        <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> extents <font color='#5555FF'>=</font> <font color='#BB00BB'>const_name</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>(</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::extents <font color='#5555FF'>+</font> <font color='#BB00BB'>const_name</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>)</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> extents.text <font color='#5555FF'>+</font> format_descriptor<font color='#5555FF'>&lt;</font>remove_all_extents_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>format</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<b><a name='PYBIND11_NAMESPACE_BEGIN'></a>PYBIND11_NAMESPACE_BEGIN</b><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>int</u></font> ExtraFlags<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='pyobject_caster'></a>pyobject_caster</b><font color='#5555FF'>&lt;</font>array_t<font color='#5555FF'>&lt;</font>T, ExtraFlags<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>using</font> type <font color='#5555FF'>=</font> array_t<font color='#5555FF'>&lt;</font>T, ExtraFlags<font color='#5555FF'>&gt;</font>;

    <font color='#0000FF'><u>bool</u></font> <b><a name='load'></a>load</b><font face='Lucida Console'>(</font>handle src, <font color='#0000FF'><u>bool</u></font> convert<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>convert <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>type::<font color='#BB00BB'>check_</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b>
        value <font color='#5555FF'>=</font> type::<font color='#BB00BB'>ensure</font><font face='Lucida Console'>(</font>src<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>bool</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> handle <b><a name='cast'></a>cast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> handle <font color='#5555FF'>&amp;</font>src, return_value_policy <font color='#009900'>/* policy */</font>, handle <font color='#009900'>/* parent */</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> src.<font color='#BB00BB'>inc_ref</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <b><a name='PYBIND11_TYPE_CASTER'></a>PYBIND11_TYPE_CASTER</b><font face='Lucida Console'>(</font>type, handle_type_name<font color='#5555FF'>&lt;</font>type<font color='#5555FF'>&gt;</font>::name<font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='compare_buffer_info'></a>compare_buffer_info</b><font color='#5555FF'>&lt;</font>T, detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::is_pod_struct<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> <font color='#0000FF'><u>bool</u></font> <b><a name='compare'></a>compare</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> buffer_info <font color='#5555FF'>&amp;</font>b<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>PyArray_EquivTypes_</font><font face='Lucida Console'>(</font>dtype::of<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font>b<font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor_name'></a>npy_format_descriptor_name</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor_name'></a>npy_format_descriptor_name</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>std::is_integral<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> const_name<font color='#5555FF'>&lt;</font>std::is_same<font color='#5555FF'>&lt;</font>T, <font color='#0000FF'><u>bool</u></font><font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
        <font color='#BB00BB'>const_name</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>bool</font>"<font face='Lucida Console'>)</font>,
        const_name<font color='#5555FF'>&lt;</font>std::is_signed<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.int</font>", "<font color='#CC0000'>numpy.uint</font>"<font face='Lucida Console'>)</font>
            <font color='#5555FF'>+</font> const_name<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>8</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor_name'></a>npy_format_descriptor_name</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>std::is_floating_point<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> const_name <font color='#5555FF'>&lt;</font> std::is_same<font color='#5555FF'>&lt;</font>T, <font color='#0000FF'><u>float</u></font><font color='#5555FF'>&gt;</font>::value
                                 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> std::is_same<font color='#5555FF'>&lt;</font>T, <font color='#0000FF'>const</font> <font color='#0000FF'><u>float</u></font><font color='#5555FF'>&gt;</font>::value
                                 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> std::is_same<font color='#5555FF'>&lt;</font>T, <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::value
                                 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> std::is_same<font color='#5555FF'>&lt;</font>T, <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::value
                                        <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>const_name</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.float</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> const_name<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>8</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                                           <font color='#BB00BB'>const_name</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.longdouble</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor_name'></a>npy_format_descriptor_name</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>is_complex<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> const_name <font color='#5555FF'>&lt;</font> std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T::value_type, <font color='#0000FF'><u>float</u></font><font color='#5555FF'>&gt;</font>::value
                                 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T::value_type, <font color='#0000FF'>const</font> <font color='#0000FF'><u>float</u></font><font color='#5555FF'>&gt;</font>::value
                                 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T::value_type, <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::value
                                 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> std::is_same<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T::value_type, <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::value
                                        <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>const_name</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.complex</font>"<font face='Lucida Console'>)</font>
                                               <font color='#5555FF'>+</font> const_name<font color='#5555FF'>&lt;</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#0000FF'>typename</font> T::value_type<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>16</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                                           <font color='#BB00BB'>const_name</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.longcomplex</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b><font color='#5555FF'>&lt;</font>
    T,
    enable_if_t<font color='#5555FF'>&lt;</font>satisfies_any_of<font color='#5555FF'>&lt;</font>T, std::is_arithmetic, is_complex<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    : npy_format_descriptor_name<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>private</font>:
    <font color='#009900'>// NB: the order here must match the one in common.h
</font>    constexpr <font color='#0000FF'>static</font> <font color='#0000FF'>const</font> <font color='#0000FF'><u>int</u></font> values[<font color='#979000'>15</font>] <font color='#5555FF'>=</font> <b>{</b>npy_api::NPY_BOOL_,
                                             npy_api::NPY_BYTE_,
                                             npy_api::NPY_UBYTE_,
                                             npy_api::NPY_INT16_,
                                             npy_api::NPY_UINT16_,
                                             npy_api::NPY_INT32_,
                                             npy_api::NPY_UINT32_,
                                             npy_api::NPY_INT64_,
                                             npy_api::NPY_UINT64_,
                                             npy_api::NPY_FLOAT_,
                                             npy_api::NPY_DOUBLE_,
                                             npy_api::NPY_LONGDOUBLE_,
                                             npy_api::NPY_CFLOAT_,
                                             npy_api::NPY_CDOUBLE_,
                                             npy_api::NPY_CLONGDOUBLE_<b>}</b>;

<font color='#0000FF'>public</font>:
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>int</u></font> value <font color='#5555FF'>=</font> values[detail::is_fmt_numeric<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::index];

    <font color='#0000FF'>static</font> pybind11::dtype <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> pybind11::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font color='#009900'>/*typenum*/</font> value<font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>is_same_ignoring_cvref<font color='#5555FF'>&lt;</font>T, PyObject <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>object</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>int</u></font> value <font color='#5555FF'>=</font> npy_api::NPY_OBJECT_;

    <font color='#0000FF'>static</font> pybind11::dtype <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> pybind11::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font color='#009900'>/*typenum*/</font> value<font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>#define</font> PYBIND11_DECL_CHAR_FMT                                                                    \
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>S</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> const_name<font color='#5555FF'>&lt;</font>N<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;                               \
    <font color='#0000FF'>static</font> pybind11::dtype <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>                                                              \
        <font color='#0000FF'>return</font> pybind11::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>string</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>S</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> std::<font color='#BB00BB'>to_string</font><font face='Lucida Console'>(</font>N<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;                             \
    <b>}</b>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>[N]<font color='#5555FF'>&gt;</font> <b>{</b>
    PYBIND11_DECL_CHAR_FMT
<b>}</b>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b><font color='#5555FF'>&lt;</font>std::array<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font>, N<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    PYBIND11_DECL_CHAR_FMT
<b>}</b>;
<font color='#0000FF'>#undef</font> PYBIND11_DECL_CHAR_FMT

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::is_array<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>private</font>:
    <font color='#0000FF'>using</font> base_descr <font color='#5555FF'>=</font> npy_format_descriptor<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>public</font>:
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::is_empty, "<font color='#CC0000'>Zero-sized arrays are not supported</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name
        <font color='#5555FF'>=</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>(</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::extents <font color='#5555FF'>+</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>)</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> base_descr::name;
    <font color='#0000FF'>static</font> pybind11::dtype <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        list shape;
        array_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>append_extents</font><font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> pybind11::dtype::<font color='#BB00BB'>from_args</font><font face='Lucida Console'>(</font>
            pybind11::<font color='#BB00BB'>make_tuple</font><font face='Lucida Console'>(</font>base_descr::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b><font color='#5555FF'>&lt;</font>T, enable_if_t<font color='#5555FF'>&lt;</font>std::is_enum<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
<font color='#0000FF'>private</font>:
    <font color='#0000FF'>using</font> base_descr <font color='#5555FF'>=</font> npy_format_descriptor<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> std::underlying_type<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>public</font>:
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> base_descr::name;
    <font color='#0000FF'>static</font> pybind11::dtype <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> base_descr::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>struct</font> <b><a name='field_descriptor'></a>field_descriptor</b> <b>{</b>
    <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>name;
    ssize_t offset;
    ssize_t size;
    std::string format;
    dtype descr;
<b>}</b>;

PYBIND11_NOINLINE <font color='#0000FF'><u>void</u></font> <b><a name='register_structured_dtype'></a>register_structured_dtype</b><font face='Lucida Console'>(</font>any_container<font color='#5555FF'>&lt;</font>field_descriptor<font color='#5555FF'>&gt;</font> fields,
                                                 <font color='#0000FF'>const</font> std::type_info <font color='#5555FF'>&amp;</font>tinfo,
                                                 ssize_t itemsize,
                                                 <font color='#0000FF'><u>bool</u></font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>direct_converter<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>, <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>

    <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>numpy_internals <font color='#5555FF'>=</font> <font color='#BB00BB'>get_numpy_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>numpy_internals.<font color='#BB00BB'>get_type_info</font><font face='Lucida Console'>(</font>tinfo, <font color='#979000'>false</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>NumPy: dtype is already registered</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>// Use ordered fields because order matters as of NumPy 1.14:
</font>    <font color='#009900'>// https://docs.scipy.org/doc/numpy/release.html#multiple-field-indexing-assignment-of-structured-arrays
</font>    std::vector<font color='#5555FF'>&lt;</font>field_descriptor<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>ordered_fields</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>fields<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    std::<font color='#BB00BB'>sort</font><font face='Lucida Console'>(</font>
        ordered_fields.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
        ordered_fields.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
        []<font face='Lucida Console'>(</font><font color='#0000FF'>const</font> field_descriptor <font color='#5555FF'>&amp;</font>a, <font color='#0000FF'>const</font> field_descriptor <font color='#5555FF'>&amp;</font>b<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> a.offset <font color='#5555FF'>&lt;</font> b.offset; <b>}</b><font face='Lucida Console'>)</font>;

    list names, formats, offsets;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>field : ordered_fields<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>field.descr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>string</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>NumPy: unsupported field dtype: `</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> field.name <font color='#5555FF'>+</font> "<font color='#CC0000'>` @ </font>"
                          <font color='#5555FF'>+</font> tinfo.<font color='#BB00BB'>name</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        names.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>pybind11::<font color='#BB00BB'>str</font><font face='Lucida Console'>(</font>field.name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        formats.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>field.descr<font face='Lucida Console'>)</font>;
        offsets.<font color='#BB00BB'>append</font><font face='Lucida Console'>(</font>pybind11::<font color='#BB00BB'>int_</font><font face='Lucida Console'>(</font>field.offset<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>dtype_ptr
        <font color='#5555FF'>=</font> pybind11::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>names<font face='Lucida Console'>)</font>, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>formats<font face='Lucida Console'>)</font>, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>offsets<font face='Lucida Console'>)</font>, itemsize<font face='Lucida Console'>)</font>
              .<font color='#BB00BB'>release</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
              .<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

    <font color='#009900'>// There is an existing bug in NumPy (as of v1.11): trailing bytes are
</font>    <font color='#009900'>// not encoded explicitly into the format string. This will supposedly
</font>    <font color='#009900'>// get fixed in v1.12; for further details, see these:
</font>    <font color='#009900'>// - https://github.com/numpy/numpy/issues/7797
</font>    <font color='#009900'>// - https://github.com/numpy/numpy/pull/7798
</font>    <font color='#009900'>// Because of this, we won't use numpy's logic to generate buffer format
</font>    <font color='#009900'>// strings and will just do it ourselves.
</font>    ssize_t offset <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    std::ostringstream oss;
    <font color='#009900'>// mark the structure as unaligned with '^', because numpy and C++ don't
</font>    <font color='#009900'>// always agree about alignment (particularly for complex), and we're
</font>    <font color='#009900'>// explicitly listing all our padding. This depends on none of the fields
</font>    <font color='#009900'>// overriding the endianness. Putting the ^ in front of individual fields
</font>    <font color='#009900'>// isn't guaranteed to work due to https://github.com/numpy/numpy/issues/9049
</font>    oss <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>^T{</font>";
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>field : ordered_fields<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>field.offset <font color='#5555FF'>&gt;</font> offset<font face='Lucida Console'>)</font> <b>{</b>
            oss <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>field.offset <font color='#5555FF'>-</font> offset<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>x</font>';
        <b>}</b>
        oss <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> field.format <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>:</font>' <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> field.name <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>:</font>';
        offset <font color='#5555FF'>=</font> field.offset <font color='#5555FF'>+</font> field.size;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>itemsize <font color='#5555FF'>&gt;</font> offset<font face='Lucida Console'>)</font> <b>{</b>
        oss <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>itemsize <font color='#5555FF'>-</font> offset<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>x</font>';
    <b>}</b>
    oss <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>}</font>';
    <font color='#0000FF'>auto</font> format_str <font color='#5555FF'>=</font> oss.<font color='#BB00BB'>str</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

    <font color='#009900'>// Smoke test: verify that NumPy properly parses our buffer format string
</font>    <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>api <font color='#5555FF'>=</font> npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>auto</font> arr <font color='#5555FF'>=</font> <font color='#BB00BB'>array</font><font face='Lucida Console'>(</font><font color='#BB00BB'>buffer_info</font><font face='Lucida Console'>(</font>nullptr, itemsize, format_str, <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>api.<font color='#BB00BB'>PyArray_EquivTypes_</font><font face='Lucida Console'>(</font>dtype_ptr, arr.<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>NumPy: invalid buffer descriptor!</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>auto</font> tindex <font color='#5555FF'>=</font> std::<font color='#BB00BB'>type_index</font><font face='Lucida Console'>(</font>tinfo<font face='Lucida Console'>)</font>;
    numpy_internals.registered_dtypes[tindex] <font color='#5555FF'>=</font> <b>{</b>dtype_ptr, std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>format_str<font face='Lucida Console'>)</font><b>}</b>;
    <font color='#BB00BB'>get_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.direct_conversions[tindex].<font color='#BB00BB'>push_back</font><font face='Lucida Console'>(</font>direct_converter<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'>typename</font> SFINAE<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='npy_format_descriptor'></a>npy_format_descriptor</b> <b>{</b>
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font>is_pod_struct<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value,
                  "<font color='#CC0000'>Attempt to use a non-POD or unimplemented POD type as a numpy dtype</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name <font color='#5555FF'>=</font> make_caster<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::name;

    <font color='#0000FF'>static</font> pybind11::dtype <b><a name='dtype'></a>dtype</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> reinterpret_borrow<font color='#5555FF'>&lt;</font>pybind11::dtype<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#BB00BB'>dtype_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>static</font> std::string <b><a name='format'></a>format</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>static</font> <font color='#0000FF'>auto</font> format_str <font color='#5555FF'>=</font> <font color='#BB00BB'>get_numpy_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.get_type_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#979000'>true</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format_str;
        <font color='#0000FF'>return</font> format_str;
    <b>}</b>

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='register_dtype'></a>register_dtype</b><font face='Lucida Console'>(</font>any_container<font color='#5555FF'>&lt;</font>field_descriptor<font color='#5555FF'>&gt;</font> fields<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>register_structured_dtype</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>move</font><font face='Lucida Console'>(</font>fields<font face='Lucida Console'>)</font>,
                                  <font color='#0000FF'>typeid</font><font face='Lucida Console'>(</font><font color='#0000FF'>typename</font> std::remove_cv<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font face='Lucida Console'>)</font>,
                                  <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>T<font face='Lucida Console'>)</font>,
                                  <font color='#5555FF'>&amp;</font>direct_converter<font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>private</font>:
    <font color='#0000FF'>static</font> PyObject <font color='#5555FF'>*</font><b><a name='dtype_ptr'></a>dtype_ptr</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>static</font> PyObject <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>get_numpy_internals</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.get_type_info<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font color='#979000'>true</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>dtype_ptr;
        <font color='#0000FF'>return</font> ptr;
    <b>}</b>

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>bool</u></font> <b><a name='direct_converter'></a>direct_converter</b><font face='Lucida Console'>(</font>PyObject <font color='#5555FF'>*</font>obj, <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font>value<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>api <font color='#5555FF'>=</font> npy_api::<font color='#BB00BB'>get</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>PyObject_TypeCheck</font><font face='Lucida Console'>(</font>obj, api.PyVoidArrType_Type_<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> descr <font color='#5555FF'>=</font> reinterpret_steal<font color='#5555FF'>&lt;</font>object<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>api.<font color='#BB00BB'>PyArray_DescrFromScalar_</font><font face='Lucida Console'>(</font>obj<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>api.<font color='#BB00BB'>PyArray_EquivTypes_</font><font face='Lucida Console'>(</font><font color='#BB00BB'>dtype_ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, descr.<font color='#BB00BB'>ptr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>PyVoidScalarObject_Proxy <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> obj<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>obval;
                <font color='#0000FF'>return</font> <font color='#979000'>true</font>;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#979000'>false</font>;
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>#ifdef</font> __CLION_IDE__ <font color='#009900'>// replace heavy macro with dummy code for the IDE (doesn't affect code)
</font>#    define <b><a name='PYBIND11_NUMPY_DTYPE'></a>PYBIND11_NUMPY_DTYPE</b><font face='Lucida Console'>(</font>Type, ...<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_NUMPY_DTYPE_EX'></a>PYBIND11_NUMPY_DTYPE_EX</b><font face='Lucida Console'>(</font>Type, ...<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>

#    define <b><a name='PYBIND11_FIELD_DESCRIPTOR_EX'></a>PYBIND11_FIELD_DESCRIPTOR_EX</b><font face='Lucida Console'>(</font>T, Field, Name<font face='Lucida Console'>)</font>                                          \
        ::pybind11::detail::field_descriptor <b>{</b>                                                    \
            Name, <font color='#BB00BB'>offsetof</font><font face='Lucida Console'>(</font>T, Field<font face='Lucida Console'>)</font>, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#BB00BB'>decltype</font><font face='Lucida Console'>(</font>std::declval<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.Field<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,                  \
                ::pybind11::format_descriptor<font color='#5555FF'>&lt;</font><font color='#BB00BB'>decltype</font><font face='Lucida Console'>(</font>std::declval<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.Field<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>format</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,       \
                ::pybind11::detail::npy_format_descriptor<font color='#5555FF'>&lt;</font>                                        \
                    <font color='#BB00BB'>decltype</font><font face='Lucida Console'>(</font>std::declval<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.Field<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>dtype</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>                                   \
        <b>}</b>

<font color='#009900'>// Extract name, offset and format descriptor for a struct field
</font>#    define <b><a name='PYBIND11_FIELD_DESCRIPTOR'></a>PYBIND11_FIELD_DESCRIPTOR</b><font face='Lucida Console'>(</font>T, Field<font face='Lucida Console'>)</font> <b><a name='PYBIND11_FIELD_DESCRIPTOR_EX'></a>PYBIND11_FIELD_DESCRIPTOR_EX</b><font face='Lucida Console'>(</font>T, Field, #Field<font face='Lucida Console'>)</font>

<font color='#009900'>// The main idea of this macro is borrowed from https://github.com/swansontec/map-macro
</font><font color='#009900'>// (C) William Swanson, Paul Fultz
</font>#    define <b><a name='PYBIND11_EVAL0'></a>PYBIND11_EVAL0</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> __VA_ARGS__
#    define <b><a name='PYBIND11_EVAL1'></a>PYBIND11_EVAL1</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b><a name='PYBIND11_EVAL0'></a>PYBIND11_EVAL0</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL0</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL0</font><font face='Lucida Console'>(</font>__VA_ARGS__<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_EVAL2'></a>PYBIND11_EVAL2</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b><a name='PYBIND11_EVAL1'></a>PYBIND11_EVAL1</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL1</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL1</font><font face='Lucida Console'>(</font>__VA_ARGS__<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_EVAL3'></a>PYBIND11_EVAL3</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b><a name='PYBIND11_EVAL2'></a>PYBIND11_EVAL2</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL2</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL2</font><font face='Lucida Console'>(</font>__VA_ARGS__<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_EVAL4'></a>PYBIND11_EVAL4</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b><a name='PYBIND11_EVAL3'></a>PYBIND11_EVAL3</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL3</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL3</font><font face='Lucida Console'>(</font>__VA_ARGS__<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_EVAL'></a>PYBIND11_EVAL</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b><a name='PYBIND11_EVAL4'></a>PYBIND11_EVAL4</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL4</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_EVAL4</font><font face='Lucida Console'>(</font>__VA_ARGS__<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_MAP_END'></a>PYBIND11_MAP_END</b><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font>
#    define PYBIND11_MAP_OUT
#    define PYBIND11_MAP_COMMA ,
#    define <b><a name='PYBIND11_MAP_GET_END'></a>PYBIND11_MAP_GET_END</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#979000'>0</font>, PYBIND11_MAP_END
#    define <b><a name='PYBIND11_MAP_NEXT0'></a>PYBIND11_MAP_NEXT0</b><font face='Lucida Console'>(</font>test, next, ...<font face='Lucida Console'>)</font> next PYBIND11_MAP_OUT
#    define <b><a name='PYBIND11_MAP_NEXT1'></a>PYBIND11_MAP_NEXT1</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font> <b><a name='PYBIND11_MAP_NEXT0'></a>PYBIND11_MAP_NEXT0</b><font face='Lucida Console'>(</font>test, next, <font color='#979000'>0</font><font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_MAP_NEXT'></a>PYBIND11_MAP_NEXT</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font> <b><a name='PYBIND11_MAP_NEXT1'></a>PYBIND11_MAP_NEXT1</b><font face='Lucida Console'>(</font>PYBIND11_MAP_GET_END test, next<font face='Lucida Console'>)</font>
#    <font color='#0000FF'>if</font> <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>_MSC_VER<font face='Lucida Console'>)</font>                                                                         \
        <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font><b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>__clang__<font face='Lucida Console'>)</font> <font color='#009900'>// MSVC is not as eager to expand macros, hence this workaround
</font>#        define <b><a name='PYBIND11_MAP_LIST_NEXT1'></a>PYBIND11_MAP_LIST_NEXT1</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font>                                               \
            <b><a name='PYBIND11_EVAL0'></a>PYBIND11_EVAL0</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_MAP_NEXT0</font><font face='Lucida Console'>(</font>test, PYBIND11_MAP_COMMA next, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#    <font color='#0000FF'>else</font>
#        define <b><a name='PYBIND11_MAP_LIST_NEXT1'></a>PYBIND11_MAP_LIST_NEXT1</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font>                                               \
            <b><a name='PYBIND11_MAP_NEXT0'></a>PYBIND11_MAP_NEXT0</b><font face='Lucida Console'>(</font>test, PYBIND11_MAP_COMMA next, <font color='#979000'>0</font><font face='Lucida Console'>)</font>
#    endif
#    define <b><a name='PYBIND11_MAP_LIST_NEXT'></a>PYBIND11_MAP_LIST_NEXT</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font>                                                    \
        <b><a name='PYBIND11_MAP_LIST_NEXT1'></a>PYBIND11_MAP_LIST_NEXT1</b><font face='Lucida Console'>(</font>PYBIND11_MAP_GET_END test, next<font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_MAP_LIST0'></a>PYBIND11_MAP_LIST0</b><font face='Lucida Console'>(</font>f, t, x, peek, ...<font face='Lucida Console'>)</font>                                                \
        <b><a name='f'></a>f</b><font face='Lucida Console'>(</font>t, x<font face='Lucida Console'>)</font> <b><a name='PYBIND11_MAP_LIST_NEXT'></a>PYBIND11_MAP_LIST_NEXT</b><font face='Lucida Console'>(</font>peek, PYBIND11_MAP_LIST1<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>f, t, peek, __VA_ARGS__<font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_MAP_LIST1'></a>PYBIND11_MAP_LIST1</b><font face='Lucida Console'>(</font>f, t, x, peek, ...<font face='Lucida Console'>)</font>                                                \
        <b><a name='f'></a>f</b><font face='Lucida Console'>(</font>t, x<font face='Lucida Console'>)</font> <b><a name='PYBIND11_MAP_LIST_NEXT'></a>PYBIND11_MAP_LIST_NEXT</b><font face='Lucida Console'>(</font>peek, PYBIND11_MAP_LIST0<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>f, t, peek, __VA_ARGS__<font face='Lucida Console'>)</font>
<font color='#009900'>// PYBIND11_MAP_LIST(f, t, a1, a2, ...) expands to f(t, a1), f(t, a2), ...
</font>#    define <b><a name='PYBIND11_MAP_LIST'></a>PYBIND11_MAP_LIST</b><font face='Lucida Console'>(</font>f, t, ...<font face='Lucida Console'>)</font>                                                          \
        <b><a name='PYBIND11_EVAL'></a>PYBIND11_EVAL</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_MAP_LIST1</font><font face='Lucida Console'>(</font>f, t, __VA_ARGS__, <font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

#    define <b><a name='PYBIND11_NUMPY_DTYPE'></a>PYBIND11_NUMPY_DTYPE</b><font face='Lucida Console'>(</font>Type, ...<font face='Lucida Console'>)</font>                                                       \
        ::pybind11::detail::npy_format_descriptor<font color='#5555FF'>&lt;</font>Type<font color='#5555FF'>&gt;</font>::<b><a name='register_dtype'></a>register_dtype</b><font face='Lucida Console'>(</font>                          \
            ::std::vector<font color='#5555FF'>&lt;</font>::pybind11::detail::field_descriptor<font color='#5555FF'>&gt;</font><b>{</b>                                  \
                <font color='#BB00BB'>PYBIND11_MAP_LIST</font><font face='Lucida Console'>(</font>PYBIND11_FIELD_DESCRIPTOR, Type, __VA_ARGS__<font face='Lucida Console'>)</font><b>}</b><font face='Lucida Console'>)</font>

#    <font color='#0000FF'>if</font> <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>_MSC_VER<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font><b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>__clang__<font face='Lucida Console'>)</font>
#        define <b><a name='PYBIND11_MAP2_LIST_NEXT1'></a>PYBIND11_MAP2_LIST_NEXT1</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font>                                              \
            <b><a name='PYBIND11_EVAL0'></a>PYBIND11_EVAL0</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_MAP_NEXT0</font><font face='Lucida Console'>(</font>test, PYBIND11_MAP_COMMA next, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#    <font color='#0000FF'>else</font>
#        define <b><a name='PYBIND11_MAP2_LIST_NEXT1'></a>PYBIND11_MAP2_LIST_NEXT1</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font>                                              \
            <b><a name='PYBIND11_MAP_NEXT0'></a>PYBIND11_MAP_NEXT0</b><font face='Lucida Console'>(</font>test, PYBIND11_MAP_COMMA next, <font color='#979000'>0</font><font face='Lucida Console'>)</font>
#    endif
#    define <b><a name='PYBIND11_MAP2_LIST_NEXT'></a>PYBIND11_MAP2_LIST_NEXT</b><font face='Lucida Console'>(</font>test, next<font face='Lucida Console'>)</font>                                                   \
        <b><a name='PYBIND11_MAP2_LIST_NEXT1'></a>PYBIND11_MAP2_LIST_NEXT1</b><font face='Lucida Console'>(</font>PYBIND11_MAP_GET_END test, next<font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_MAP2_LIST0'></a>PYBIND11_MAP2_LIST0</b><font face='Lucida Console'>(</font>f, t, x1, x2, peek, ...<font face='Lucida Console'>)</font>                                          \
        <b><a name='f'></a>f</b><font face='Lucida Console'>(</font>t, x1, x2<font face='Lucida Console'>)</font> <b><a name='PYBIND11_MAP2_LIST_NEXT'></a>PYBIND11_MAP2_LIST_NEXT</b><font face='Lucida Console'>(</font>peek, PYBIND11_MAP2_LIST1<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>f, t, peek, __VA_ARGS__<font face='Lucida Console'>)</font>
#    define <b><a name='PYBIND11_MAP2_LIST1'></a>PYBIND11_MAP2_LIST1</b><font face='Lucida Console'>(</font>f, t, x1, x2, peek, ...<font face='Lucida Console'>)</font>                                          \
        <b><a name='f'></a>f</b><font face='Lucida Console'>(</font>t, x1, x2<font face='Lucida Console'>)</font> <b><a name='PYBIND11_MAP2_LIST_NEXT'></a>PYBIND11_MAP2_LIST_NEXT</b><font face='Lucida Console'>(</font>peek, PYBIND11_MAP2_LIST0<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>f, t, peek, __VA_ARGS__<font face='Lucida Console'>)</font>
<font color='#009900'>// PYBIND11_MAP2_LIST(f, t, a1, a2, ...) expands to f(t, a1, a2), f(t, a3, a4), ...
</font>#    define <b><a name='PYBIND11_MAP2_LIST'></a>PYBIND11_MAP2_LIST</b><font face='Lucida Console'>(</font>f, t, ...<font face='Lucida Console'>)</font>                                                         \
        <b><a name='PYBIND11_EVAL'></a>PYBIND11_EVAL</b><font face='Lucida Console'>(</font><font color='#BB00BB'>PYBIND11_MAP2_LIST1</font><font face='Lucida Console'>(</font>f, t, __VA_ARGS__, <font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

#    define <b><a name='PYBIND11_NUMPY_DTYPE_EX'></a>PYBIND11_NUMPY_DTYPE_EX</b><font face='Lucida Console'>(</font>Type, ...<font face='Lucida Console'>)</font>                                                    \
        ::pybind11::detail::npy_format_descriptor<font color='#5555FF'>&lt;</font>Type<font color='#5555FF'>&gt;</font>::<b><a name='register_dtype'></a>register_dtype</b><font face='Lucida Console'>(</font>                          \
            ::std::vector<font color='#5555FF'>&lt;</font>::pybind11::detail::field_descriptor<font color='#5555FF'>&gt;</font><b>{</b>                                  \
                <font color='#BB00BB'>PYBIND11_MAP2_LIST</font><font face='Lucida Console'>(</font>PYBIND11_FIELD_DESCRIPTOR_EX, Type, __VA_ARGS__<font face='Lucida Console'>)</font><b>}</b><font face='Lucida Console'>)</font>

<font color='#0000FF'>#endif</font> <font color='#009900'>// __CLION_IDE__
</font>
<font color='#0000FF'>class</font> <b><a name='common_iterator'></a>common_iterator</b> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'>using</font> container_type <font color='#5555FF'>=</font> std::vector<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>using</font> value_type <font color='#5555FF'>=</font> container_type::value_type;
    <font color='#0000FF'>using</font> size_type <font color='#5555FF'>=</font> container_type::size_type;

    <b><a name='common_iterator'></a>common_iterator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> : m_strides<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    <b><a name='common_iterator'></a>common_iterator</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>ptr, <font color='#0000FF'>const</font> container_type <font color='#5555FF'>&amp;</font>strides, <font color='#0000FF'>const</font> container_type <font color='#5555FF'>&amp;</font>shape<font face='Lucida Console'>)</font>
        : p_ptr<font face='Lucida Console'>(</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, m_strides<font face='Lucida Console'>(</font>strides.size<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        m_strides.<font color='#BB00BB'>back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>value_type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>strides.<font color='#BB00BB'>back</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>size_type i <font color='#5555FF'>=</font> m_strides.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>; i <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#5555FF'>-</font><font color='#5555FF'>-</font>i<font face='Lucida Console'>)</font> <b>{</b>
            size_type j <font color='#5555FF'>=</font> i <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            <font color='#0000FF'>auto</font> s <font color='#5555FF'>=</font> <font color='#0000FF'>static_cast</font><font color='#5555FF'>&lt;</font>value_type<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>shape[i]<font face='Lucida Console'>)</font>;
            m_strides[j] <font color='#5555FF'>=</font> strides[j] <font color='#5555FF'>+</font> m_strides[i] <font color='#5555FF'>-</font> strides[i] <font color='#5555FF'>*</font> s;
        <b>}</b>
    <b>}</b>

    <font color='#0000FF'><u>void</u></font> <b><a name='increment'></a>increment</b><font face='Lucida Console'>(</font>size_type dim<font face='Lucida Console'>)</font> <b>{</b> p_ptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> m_strides[dim]; <b>}</b>

    <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><b><a name='data'></a>data</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b> <font color='#0000FF'>return</font> p_ptr; <b>}</b>

<font color='#0000FF'>private</font>:
    <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>p_ptr<b>{</b>nullptr<b>}</b>;
    container_type m_strides;
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>class</font> <b><a name='multi_array_iterator'></a>multi_array_iterator</b> <b>{</b>
<font color='#0000FF'>public</font>:
    <font color='#0000FF'>using</font> container_type <font color='#5555FF'>=</font> std::vector<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font>;

    <b><a name='multi_array_iterator'></a>multi_array_iterator</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::array<font color='#5555FF'>&lt;</font>buffer_info, N<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>buffers, <font color='#0000FF'>const</font> container_type <font color='#5555FF'>&amp;</font>shape<font face='Lucida Console'>)</font>
        : m_shape<font face='Lucida Console'>(</font>shape.size<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>, m_index<font face='Lucida Console'>(</font>shape.size<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font><font face='Lucida Console'>)</font>, m_common_iterator<font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>

        <font color='#009900'>// Manual copy to avoid conversion warning if using std::copy
</font>        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> shape.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font> <b>{</b>
            m_shape[i] <font color='#5555FF'>=</font> shape[i];
        <b>}</b>

        container_type <font color='#BB00BB'>strides</font><font face='Lucida Console'>(</font>shape.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> N; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>init_common_iterator</font><font face='Lucida Console'>(</font>buffers[i], shape, m_common_iterator[i], strides<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    multi_array_iterator <font color='#5555FF'>&amp;</font><b><a name='operator'></a>operator</b><font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> j <font color='#5555FF'>=</font> m_index.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; j <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#5555FF'>-</font><font color='#5555FF'>-</font>j<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> j <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>m_index[i] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> m_shape[i]<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>increment_common_iterator</font><font face='Lucida Console'>(</font>i<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>break</font>;
            <b>}</b>
            m_index[i] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> <font color='#5555FF'>*</font><font color='#0000FF'>this</font>;
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> K, <font color='#0000FF'>class</font> <b><a name='T'></a>T</b> <font color='#5555FF'>=</font> <font color='#0000FF'><u>void</u></font><font color='#5555FF'>&gt;</font>
    T <font color='#5555FF'>*</font><b><a name='data'></a>data</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#0000FF'>const</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>T <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>m_common_iterator[K].<font color='#BB00BB'>data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>private</font>:
    <font color='#0000FF'>using</font> common_iter <font color='#5555FF'>=</font> common_iterator;

    <font color='#0000FF'><u>void</u></font> <b><a name='init_common_iterator'></a>init_common_iterator</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> buffer_info <font color='#5555FF'>&amp;</font>buffer,
                              <font color='#0000FF'>const</font> container_type <font color='#5555FF'>&amp;</font>shape,
                              common_iter <font color='#5555FF'>&amp;</font>iterator,
                              container_type <font color='#5555FF'>&amp;</font>strides<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> buffer_shape_iter <font color='#5555FF'>=</font> buffer.shape.<font color='#BB00BB'>rbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> buffer_strides_iter <font color='#5555FF'>=</font> buffer.strides.<font color='#BB00BB'>rbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> shape_iter <font color='#5555FF'>=</font> shape.<font color='#BB00BB'>rbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> strides_iter <font color='#5555FF'>=</font> strides.<font color='#BB00BB'>rbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>buffer_shape_iter <font color='#5555FF'>!</font><font color='#5555FF'>=</font> buffer.shape.<font color='#BB00BB'>rend</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>shape_iter <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>buffer_shape_iter<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#5555FF'>*</font>strides_iter <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>buffer_strides_iter;
            <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
                <font color='#5555FF'>*</font>strides_iter <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <b>}</b>

            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>buffer_shape_iter;
            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>buffer_strides_iter;
            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>shape_iter;
            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>strides_iter;
        <b>}</b>

        std::<font color='#BB00BB'>fill</font><font face='Lucida Console'>(</font>strides_iter, strides.<font color='#BB00BB'>rend</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        iterator <font color='#5555FF'>=</font> <font color='#BB00BB'>common_iter</font><font face='Lucida Console'>(</font>buffer.ptr, strides, shape<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'><u>void</u></font> <b><a name='increment_common_iterator'></a>increment_common_iterator</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> dim<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>iter : m_common_iterator<font face='Lucida Console'>)</font> <b>{</b>
            iter.<font color='#BB00BB'>increment</font><font face='Lucida Console'>(</font>dim<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>

    container_type m_shape;
    container_type m_index;
    std::array<font color='#5555FF'>&lt;</font>common_iter, N<font color='#5555FF'>&gt;</font> m_common_iterator;
<b>}</b>;

<font color='#0000FF'>enum</font> <font color='#0000FF'>class</font> <b><a name='broadcast_trivial'></a>broadcast_trivial</b> <b>{</b> non_trivial, c_trivial, f_trivial <b>}</b>;

<font color='#009900'>// Populates the shape and number of dimensions for the set of buffers.  Returns a
</font><font color='#009900'>// broadcast_trivial enum value indicating whether the broadcast is "trivial"--that is, has each
</font><font color='#009900'>// buffer being either a singleton or a full-size, C-contiguous (`c_trivial`) or Fortran-contiguous
</font><font color='#009900'>// (`f_trivial`) storage buffer; returns `non_trivial` otherwise.
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> N<font color='#5555FF'>&gt;</font>
broadcast_trivial
<b><a name='broadcast'></a>broadcast</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> std::array<font color='#5555FF'>&lt;</font>buffer_info, N<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>buffers, ssize_t <font color='#5555FF'>&amp;</font>ndim, std::vector<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>shape<font face='Lucida Console'>)</font> <b>{</b>
    ndim <font color='#5555FF'>=</font> std::<font color='#BB00BB'>accumulate</font><font face='Lucida Console'>(</font>
        buffers.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, buffers.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>ssize_t</font><font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>, []<font face='Lucida Console'>(</font>ssize_t res, <font color='#0000FF'>const</font> buffer_info <font color='#5555FF'>&amp;</font>buf<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> std::<font color='#BB00BB'>max</font><font face='Lucida Console'>(</font>res, buf.ndim<font face='Lucida Console'>)</font>;
        <b>}</b><font face='Lucida Console'>)</font>;

    shape.<font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    shape.<font color='#BB00BB'>resize</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> ndim, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

    <font color='#009900'>// Figure out the output size, and make sure all input arrays conform (i.e. are either size 1
</font>    <font color='#009900'>// or the full size).
</font>    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> N; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>auto</font> res_iter <font color='#5555FF'>=</font> shape.<font color='#BB00BB'>rbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> end <font color='#5555FF'>=</font> buffers[i].shape.<font color='#BB00BB'>rend</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> shape_iter <font color='#5555FF'>=</font> buffers[i].shape.<font color='#BB00BB'>rbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; shape_iter <font color='#5555FF'>!</font><font color='#5555FF'>=</font> end;
             <font color='#5555FF'>+</font><font color='#5555FF'>+</font>shape_iter, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>res_iter<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>dim_size_in <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>shape_iter;
            <font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>dim_size_out <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>res_iter;

            <font color='#009900'>// Each input dimension can either be 1 or `n`, but `n` values must match across
</font>            <font color='#009900'>// buffers
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dim_size_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
                dim_size_out <font color='#5555FF'>=</font> dim_size_in;
            <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dim_size_in <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> dim_size_in <font color='#5555FF'>!</font><font color='#5555FF'>=</font> dim_size_out<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>pybind11_fail</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>pybind11::vectorize: incompatible size/dimension of inputs!</font>"<font face='Lucida Console'>)</font>;
            <b>}</b>
        <b>}</b>
    <b>}</b>

    <font color='#0000FF'><u>bool</u></font> trivial_broadcast_c <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
    <font color='#0000FF'><u>bool</u></font> trivial_broadcast_f <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> N <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>trivial_broadcast_c <font color='#5555FF'>|</font><font color='#5555FF'>|</font> trivial_broadcast_f<font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffers[i].size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>continue</font>;
        <b>}</b>

        <font color='#009900'>// Require the same number of dimensions:
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffers[i].ndim <font color='#5555FF'>!</font><font color='#5555FF'>=</font> ndim<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> broadcast_trivial::non_trivial;
        <b>}</b>

        <font color='#009900'>// Require all dimensions be full-size:
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::<font color='#BB00BB'>equal</font><font face='Lucida Console'>(</font>buffers[i].shape.<font color='#BB00BB'>cbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, buffers[i].shape.<font color='#BB00BB'>cend</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, shape.<font color='#BB00BB'>cbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> broadcast_trivial::non_trivial;
        <b>}</b>

        <font color='#009900'>// Check for C contiguity (but only if previous inputs were also C contiguous)
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>trivial_broadcast_c<font face='Lucida Console'>)</font> <b>{</b>
            ssize_t expect_stride <font color='#5555FF'>=</font> buffers[i].itemsize;
            <font color='#0000FF'>auto</font> end <font color='#5555FF'>=</font> buffers[i].shape.<font color='#BB00BB'>crend</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> shape_iter <font color='#5555FF'>=</font> buffers[i].shape.<font color='#BB00BB'>crbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                      stride_iter <font color='#5555FF'>=</font> buffers[i].strides.<font color='#BB00BB'>crbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                 trivial_broadcast_c <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> shape_iter <font color='#5555FF'>!</font><font color='#5555FF'>=</font> end;
                 <font color='#5555FF'>+</font><font color='#5555FF'>+</font>shape_iter, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>stride_iter<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>expect_stride <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>stride_iter<font face='Lucida Console'>)</font> <b>{</b>
                    expect_stride <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>shape_iter;
                <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
                    trivial_broadcast_c <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                <b>}</b>
            <b>}</b>
        <b>}</b>

        <font color='#009900'>// Check for Fortran contiguity (if previous inputs were also F contiguous)
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>trivial_broadcast_f<font face='Lucida Console'>)</font> <b>{</b>
            ssize_t expect_stride <font color='#5555FF'>=</font> buffers[i].itemsize;
            <font color='#0000FF'>auto</font> end <font color='#5555FF'>=</font> buffers[i].shape.<font color='#BB00BB'>cend</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> shape_iter <font color='#5555FF'>=</font> buffers[i].shape.<font color='#BB00BB'>cbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                      stride_iter <font color='#5555FF'>=</font> buffers[i].strides.<font color='#BB00BB'>cbegin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                 trivial_broadcast_f <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> shape_iter <font color='#5555FF'>!</font><font color='#5555FF'>=</font> end;
                 <font color='#5555FF'>+</font><font color='#5555FF'>+</font>shape_iter, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>stride_iter<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>expect_stride <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>stride_iter<font face='Lucida Console'>)</font> <b>{</b>
                    expect_stride <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>shape_iter;
                <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
                    trivial_broadcast_f <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                <b>}</b>
            <b>}</b>
        <b>}</b>
    <b>}</b>

    <font color='#0000FF'>return</font> trivial_broadcast_c   ? broadcast_trivial::c_trivial
           : trivial_broadcast_f ? broadcast_trivial::f_trivial
                                 : broadcast_trivial::non_trivial;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='vectorize_arg'></a>vectorize_arg</b> <b>{</b>
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::is_rvalue_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value,
                  "<font color='#CC0000'>Functions with rvalue reference arguments cannot be vectorized</font>"<font face='Lucida Console'>)</font>;
    <font color='#009900'>// The wrapped function gets called with this type:
</font>    <font color='#0000FF'>using</font> call_type <font color='#5555FF'>=</font> remove_reference_t<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>;
    <font color='#009900'>// Is this a vectorized argument?
</font>    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>bool</u></font> vectorize
        <font color='#5555FF'>=</font> satisfies_any_of<font color='#5555FF'>&lt;</font>call_type, std::is_arithmetic, is_complex, is_pod<font color='#5555FF'>&gt;</font>::value
          <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> satisfies_none_of<font color='#5555FF'>&lt;</font>call_type,
                               std::is_pointer,
                               std::is_array,
                               is_std_array,
                               std::is_enum<font color='#5555FF'>&gt;</font>::value
          <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>std::is_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value
              <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>std::is_lvalue_reference<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> std::is_const<font color='#5555FF'>&lt;</font>call_type<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#009900'>// Accept this type: an array for vectorized types, otherwise the type as-is:
</font>    <font color='#0000FF'>using</font> type <font color='#5555FF'>=</font> conditional_t<font color='#5555FF'>&lt;</font>vectorize, array_t<font color='#5555FF'>&lt;</font>remove_cv_t<font color='#5555FF'>&lt;</font>call_type<font color='#5555FF'>&gt;</font>, array::forcecast<font color='#5555FF'>&gt;</font>, T<font color='#5555FF'>&gt;</font>;
<b>}</b>;

<font color='#009900'>// py::vectorize when a return type is present
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Func, <font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='vectorize_returned_array'></a>vectorize_returned_array</b> <b>{</b>
    <font color='#0000FF'>using</font> Type <font color='#5555FF'>=</font> array_t<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font>;

    <font color='#0000FF'>static</font> Type <b><a name='create'></a>create</b><font face='Lucida Console'>(</font>broadcast_trivial trivial, <font color='#0000FF'>const</font> std::vector<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>shape<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>trivial <font color='#5555FF'>=</font><font color='#5555FF'>=</font> broadcast_trivial::f_trivial<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> array_t<font color='#5555FF'>&lt;</font>Return, array::f_style<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>return</font> array_t<font color='#5555FF'>&lt;</font>Return<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>shape<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#0000FF'>static</font> Return <font color='#5555FF'>*</font><b><a name='mutable_data'></a>mutable_data</b><font face='Lucida Console'>(</font>Type <font color='#5555FF'>&amp;</font>array<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> array.<font color='#BB00BB'>mutable_data</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>static</font> Return <b><a name='call'></a>call</b><font face='Lucida Console'>(</font>Func <font color='#5555FF'>&amp;</font>f, Args <font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>args...<font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='call'></a>call</b><font face='Lucida Console'>(</font>Return <font color='#5555FF'>*</font>out, <font color='#0000FF'><u>size_t</u></font> i, Func <font color='#5555FF'>&amp;</font>f, Args <font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b> out[i] <font color='#5555FF'>=</font> <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>args...<font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#009900'>// py::vectorize when a return type is not present
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Func, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='vectorize_returned_array'></a>vectorize_returned_array</b><font color='#5555FF'>&lt;</font>Func, <font color='#0000FF'><u>void</u></font>, Args...<font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>using</font> Type <font color='#5555FF'>=</font> none;

    <font color='#0000FF'>static</font> Type <b><a name='create'></a>create</b><font face='Lucida Console'>(</font>broadcast_trivial, <font color='#0000FF'>const</font> std::vector<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> <font color='#BB00BB'>none</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <b>}</b>

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font><b><a name='mutable_data'></a>mutable_data</b><font face='Lucida Console'>(</font>Type <font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> nullptr; <b>}</b>

    <font color='#0000FF'>static</font> detail::void_type <b><a name='call'></a>call</b><font face='Lucida Console'>(</font>Func <font color='#5555FF'>&amp;</font>f, Args <font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>args...<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> <b>{</b><b>}</b>;
    <b>}</b>

    <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='call'></a>call</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, <font color='#0000FF'><u>size_t</u></font>, Func <font color='#5555FF'>&amp;</font>f, Args <font color='#5555FF'>&amp;</font>...args<font face='Lucida Console'>)</font> <b>{</b> <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>args...<font face='Lucida Console'>)</font>; <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Func, <font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='vectorize_helper'></a>vectorize_helper</b> <b>{</b>

<font color='#009900'>// NVCC for some reason breaks if NVectorized is private
</font><font color='#0000FF'>#ifdef</font> __CUDACC__
<font color='#0000FF'>public</font>:
<font color='#0000FF'>#else</font>
<font color='#0000FF'>private</font>:
<font color='#0000FF'>#endif</font>

    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>size_t</u></font> N <font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font>...<font face='Lucida Console'>(</font>Args<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'><u>size_t</u></font> NVectorized <font color='#5555FF'>=</font> <b><a name='constexpr_sum'></a>constexpr_sum</b><font face='Lucida Console'>(</font>vectorize_arg<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>::vectorize...<font face='Lucida Console'>)</font>;
    <b><a name='static_assert'></a>static_assert</b><font face='Lucida Console'>(</font>
        NVectorized <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>,
        "<font color='#CC0000'>pybind11::vectorize(...) requires a function with at least one vectorizable argument</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>public</font>:
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T,
              <font color='#009900'>// SFINAE to prevent shadowing the copy constructor.
</font>              <font color='#0000FF'>typename</font> <font color='#5555FF'>=</font> detail::enable_if_t<font color='#5555FF'>&lt;</font>
                  <font color='#5555FF'>!</font>std::is_same<font color='#5555FF'>&lt;</font>vectorize_helper, <font color='#0000FF'>typename</font> std::decay<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::type<font color='#5555FF'>&gt;</font>::value<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>explicit</font> <b><a name='vectorize_helper'></a>vectorize_helper</b><font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>f<font face='Lucida Console'>)</font> : f<font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b><b>}</b>

    object <b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>typename</font> vectorize_arg<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>::type... args<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> <font color='#BB00BB'>run</font><font face='Lucida Console'>(</font>args...,
                   make_index_sequence<font color='#5555FF'>&lt;</font>N<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                   select_indices<font color='#5555FF'>&lt;</font>vectorize_arg<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>::vectorize...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,
                   make_index_sequence<font color='#5555FF'>&lt;</font>NVectorized<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#0000FF'>private</font>:
    remove_reference_t<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font> f;

    <font color='#009900'>// Internal compiler error in MSVC 19.16.27025.1 (Visual Studio 2017 15.9.4), when compiling
</font>    <font color='#009900'>// with "/permissive-" flag when arg_call_types is manually inlined.
</font>    <font color='#0000FF'>using</font> arg_call_types <font color='#5555FF'>=</font> std::tuple<font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> vectorize_arg<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>::call_type...<font color='#5555FF'>&gt;</font>;
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font> Index<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>using</font> param_n_t <font color='#5555FF'>=</font> <font color='#0000FF'>typename</font> std::tuple_element<font color='#5555FF'>&lt;</font>Index, arg_call_types<font color='#5555FF'>&gt;</font>::type;

    <font color='#0000FF'>using</font> returned_array <font color='#5555FF'>=</font> vectorize_returned_array<font color='#5555FF'>&lt;</font>Func, Return, Args...<font color='#5555FF'>&gt;</font>;

    <font color='#009900'>// Runs a vectorized function given arguments tuple and three index sequences:
</font>    <font color='#009900'>//     - Index is the full set of 0 ... (N-1) argument indices;
</font>    <font color='#009900'>//     - VIndex is the subset of argument indices with vectorized parameters, letting us access
</font>    <font color='#009900'>//       vectorized arguments (anything not in this sequence is passed through)
</font>    <font color='#009900'>//     - BIndex is a incremental sequence (beginning at 0) of the same size as VIndex, so that
</font>    <font color='#009900'>//       we can store vectorized buffer_infos in an array (argument VIndex has its buffer at
</font>    <font color='#009900'>//       index BIndex in the array).
</font>    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font>... Index, <font color='#0000FF'><u>size_t</u></font>... VIndex, <font color='#0000FF'><u>size_t</u></font>... BIndex<font color='#5555FF'>&gt;</font>
    object <b><a name='run'></a>run</b><font face='Lucida Console'>(</font><font color='#0000FF'>typename</font> vectorize_arg<font color='#5555FF'>&lt;</font>Args<font color='#5555FF'>&gt;</font>::type <font color='#5555FF'>&amp;</font>...args,
               index_sequence<font color='#5555FF'>&lt;</font>Index...<font color='#5555FF'>&gt;</font> i_seq,
               index_sequence<font color='#5555FF'>&lt;</font>VIndex...<font color='#5555FF'>&gt;</font> vi_seq,
               index_sequence<font color='#5555FF'>&lt;</font>BIndex...<font color='#5555FF'>&gt;</font> bi_seq<font face='Lucida Console'>)</font> <b>{</b>

        <font color='#009900'>// Pointers to values the function was called with; the vectorized ones set here will start
</font>        <font color='#009900'>// out as array_t&lt;T&gt; pointers, but they will be changed them to T pointers before we make
</font>        <font color='#009900'>// call the wrapped function.  Non-vectorized pointers are left as-is.
</font>        std::array<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, N<font color='#5555FF'>&gt;</font> params<b>{</b><b>{</b><font color='#5555FF'>&amp;</font>args...<b>}</b><b>}</b>;

        <font color='#009900'>// The array of `buffer_info`s of vectorized arguments:
</font>        std::array<font color='#5555FF'>&lt;</font>buffer_info, NVectorized<font color='#5555FF'>&gt;</font> buffers<b>{</b>
            <b>{</b><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>array <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>params[VIndex]<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>request</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>...<b>}</b><b>}</b>;

        <font color='#009900'>/* Determine dimensions parameters of output array */</font>
        ssize_t nd <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        std::vector<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>shape</font><font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> trivial <font color='#5555FF'>=</font> <font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font>buffers, nd, shape<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>auto</font> ndim <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> nd;

        <font color='#0000FF'><u>size_t</u></font> size
            <font color='#5555FF'>=</font> std::<font color='#BB00BB'>accumulate</font><font face='Lucida Console'>(</font>shape.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, shape.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font><font face='Lucida Console'>)</font> <font color='#979000'>1</font>, std::multiplies<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        <font color='#009900'>// If all arguments are 0-dimension arrays (i.e. single values) return a plain value (i.e.
</font>        <font color='#009900'>// not wrapped in an array).
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ndim <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>PYBIND11_EXPAND_SIDE_EFFECTS</font><font face='Lucida Console'>(</font>params[VIndex] <font color='#5555FF'>=</font> buffers[BIndex].ptr<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> <font color='#BB00BB'>cast</font><font face='Lucida Console'>(</font>
                returned_array::<font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>f, <font color='#5555FF'>*</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>param_n_t<font color='#5555FF'>&lt;</font>Index<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>params[Index]<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#0000FF'>auto</font> result <font color='#5555FF'>=</font> returned_array::<font color='#BB00BB'>create</font><font face='Lucida Console'>(</font>trivial, shape<font face='Lucida Console'>)</font>;

        PYBIND11_WARNING_PUSH
<font color='#0000FF'>#ifdef</font> PYBIND11_DETECTED_CLANG_WITH_MISLEADING_CALL_STD_MOVE_EXPLICITLY_WARNING
        <font color='#BB00BB'>PYBIND11_WARNING_DISABLE_CLANG</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>-Wreturn-std-move</font>"<font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>return</font> result;
        <b>}</b>

        <font color='#009900'>/* Call the function */</font>
        <font color='#0000FF'>auto</font> <font color='#5555FF'>*</font>mutable_data <font color='#5555FF'>=</font> returned_array::<font color='#BB00BB'>mutable_data</font><font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>trivial <font color='#5555FF'>=</font><font color='#5555FF'>=</font> broadcast_trivial::non_trivial<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>apply_broadcast</font><font face='Lucida Console'>(</font>buffers, params, mutable_data, size, shape, i_seq, vi_seq, bi_seq<font face='Lucida Console'>)</font>;
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
            <font color='#BB00BB'>apply_trivial</font><font face='Lucida Console'>(</font>buffers, params, mutable_data, size, i_seq, vi_seq, bi_seq<font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#0000FF'>return</font> result;
        PYBIND11_WARNING_POP
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font>... Index, <font color='#0000FF'><u>size_t</u></font>... VIndex, <font color='#0000FF'><u>size_t</u></font>... BIndex<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='apply_trivial'></a>apply_trivial</b><font face='Lucida Console'>(</font>std::array<font color='#5555FF'>&lt;</font>buffer_info, NVectorized<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>buffers,
                       std::array<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, N<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>params,
                       Return <font color='#5555FF'>*</font>out,
                       <font color='#0000FF'><u>size_t</u></font> size,
                       index_sequence<font color='#5555FF'>&lt;</font>Index...<font color='#5555FF'>&gt;</font>,
                       index_sequence<font color='#5555FF'>&lt;</font>VIndex...<font color='#5555FF'>&gt;</font>,
                       index_sequence<font color='#5555FF'>&lt;</font>BIndex...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b>

        <font color='#009900'>// Initialize an array of mutable byte references and sizes with references set to the
</font>        <font color='#009900'>// appropriate pointer in `params`; as we iterate, we'll increment each pointer by its size
</font>        <font color='#009900'>// (except for singletons, which get an increment of 0).
</font>        std::array<font color='#5555FF'>&lt;</font>std::pair<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font>, <font color='#0000FF'>const</font> <font color='#0000FF'><u>size_t</u></font><font color='#5555FF'>&gt;</font>, NVectorized<font color='#5555FF'>&gt;</font> vecparams<b>{</b>
            <b>{</b>std::pair<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font>, <font color='#0000FF'>const</font> <font color='#0000FF'><u>size_t</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>
                <font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font><font color='#5555FF'>&amp;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>params[VIndex] <font color='#5555FF'>=</font> buffers[BIndex].ptr<font face='Lucida Console'>)</font>,
                buffers[BIndex].size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> ? <font color='#979000'>0</font> : <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>param_n_t<font color='#5555FF'>&lt;</font>VIndex<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>...<b>}</b><b>}</b>;

        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> size; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font> <b>{</b>
            returned_array::<font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>
                out, i, f, <font color='#5555FF'>*</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>param_n_t<font color='#5555FF'>&lt;</font>Index<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>params[Index]<font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'>auto</font> <font color='#5555FF'>&amp;</font>x : vecparams<font face='Lucida Console'>)</font> <b>{</b>
                x.first <font color='#5555FF'>+</font><font color='#5555FF'>=</font> x.second;
            <b>}</b>
        <b>}</b>
    <b>}</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>size_t</u></font>... Index, <font color='#0000FF'><u>size_t</u></font>... VIndex, <font color='#0000FF'><u>size_t</u></font>... BIndex<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='apply_broadcast'></a>apply_broadcast</b><font face='Lucida Console'>(</font>std::array<font color='#5555FF'>&lt;</font>buffer_info, NVectorized<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>buffers,
                         std::array<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>, N<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>params,
                         Return <font color='#5555FF'>*</font>out,
                         <font color='#0000FF'><u>size_t</u></font> size,
                         <font color='#0000FF'>const</font> std::vector<font color='#5555FF'>&lt;</font>ssize_t<font color='#5555FF'>&gt;</font> <font color='#5555FF'>&amp;</font>output_shape,
                         index_sequence<font color='#5555FF'>&lt;</font>Index...<font color='#5555FF'>&gt;</font>,
                         index_sequence<font color='#5555FF'>&lt;</font>VIndex...<font color='#5555FF'>&gt;</font>,
                         index_sequence<font color='#5555FF'>&lt;</font>BIndex...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>)</font> <b>{</b>

        multi_array_iterator<font color='#5555FF'>&lt;</font>NVectorized<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>input_iter</font><font face='Lucida Console'>(</font>buffers, output_shape<font face='Lucida Console'>)</font>;

        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>size_t</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> size; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>input_iter<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>PYBIND11_EXPAND_SIDE_EFFECTS</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>params[VIndex] <font color='#5555FF'>=</font> input_iter.<font color='#0000FF'>template</font> data<font color='#5555FF'>&lt;</font>BIndex<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            returned_array::<font color='#BB00BB'>call</font><font face='Lucida Console'>(</font>
                out, i, f, <font color='#5555FF'>*</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>param_n_t<font color='#5555FF'>&lt;</font>Index<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>std::get<font color='#5555FF'>&lt;</font>Index<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>params<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>...<font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>
<b>}</b>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Func, <font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
vectorize_helper<font color='#5555FF'>&lt;</font>Func, Return, Args...<font color='#5555FF'>&gt;</font> <b><a name='vectorize_extractor'></a>vectorize_extractor</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> Func <font color='#5555FF'>&amp;</font>f, <font color='#BB00BB'>Return</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> detail::vectorize_helper<font color='#5555FF'>&lt;</font>Func, Return, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T, <font color='#0000FF'><u>int</u></font> Flags<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>struct</font> <b><a name='handle_type_name'></a>handle_type_name</b><font color='#5555FF'>&lt;</font>array_t<font color='#5555FF'>&lt;</font>T, Flags<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <b>{</b>
    <font color='#0000FF'>static</font> constexpr <font color='#0000FF'>auto</font> name
        <font color='#5555FF'>=</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>numpy.ndarray[</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> npy_format_descriptor<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::name <font color='#5555FF'>+</font> <b><a name='const_name'></a>const_name</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>]</font>"<font face='Lucida Console'>)</font>;
<b>}</b>;

<b><a name='PYBIND11_NAMESPACE_END'></a>PYBIND11_NAMESPACE_END</b><font face='Lucida Console'>(</font>detail<font face='Lucida Console'>)</font>

<font color='#009900'>// Vanilla pointer vectorizer:
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Return, <font color='#0000FF'>typename</font>... Args<font color='#5555FF'>&gt;</font>
detail::vectorize_helper<font color='#5555FF'>&lt;</font><b><a name='Return'></a>Return</b> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font>, Return, Args...<font color='#5555FF'>&gt;</font> <b><a name='vectorize'></a>vectorize</b><font face='Lucida Console'>(</font><font color='#BB00BB'>Return</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> detail::vectorize_helper<font color='#5555FF'>&lt;</font><font color='#BB00BB'>Return</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font>, Return, Args...<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// lambda vectorizer:
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Func, detail::enable_if_t<font color='#5555FF'>&lt;</font>detail::is_lambda<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font>::value, <font color='#0000FF'><u>int</u></font><font color='#5555FF'>&gt;</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font><font color='#5555FF'>&gt;</font>
<font color='#0000FF'>auto</font> <b><a name='vectorize'></a>vectorize</b><font face='Lucida Console'>(</font>Func <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>f<font face='Lucida Console'>)</font>
    <font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font> <b><a name='decltype'></a>decltype</b><font face='Lucida Console'>(</font>detail::<font color='#BB00BB'>vectorize_extractor</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>,
                                            <font face='Lucida Console'>(</font>detail::function_signature_t<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> nullptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> detail::<font color='#BB00BB'>vectorize_extractor</font><font face='Lucida Console'>(</font>std::forward<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>,
                                       <font face='Lucida Console'>(</font>detail::function_signature_t<font color='#5555FF'>&lt;</font>Func<font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> nullptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// Vectorize a class method (non-const):
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Return,
          <font color='#0000FF'>typename</font> Class,
          <font color='#0000FF'>typename</font>... Args,
          <font color='#0000FF'>typename</font> Helper <font color='#5555FF'>=</font> detail::vectorize_helper<font color='#5555FF'>&lt;</font>
              <b><a name='decltype'></a>decltype</b><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>mem_fn</font><font face='Lucida Console'>(</font>std::declval<font color='#5555FF'>&lt;</font><font color='#BB00BB'>Return</font> <font face='Lucida Console'>(</font>Class::<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
              Return,
              Class <font color='#5555FF'>*</font>,
              Args...<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
Helper <b><a name='vectorize'></a>vectorize</b><font face='Lucida Console'>(</font><font color='#BB00BB'>Return</font> <font face='Lucida Console'>(</font>Class::<font color='#5555FF'>*</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#BB00BB'>Helper</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>mem_fn</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>// Vectorize a class method (const):
</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Return,
          <font color='#0000FF'>typename</font> Class,
          <font color='#0000FF'>typename</font>... Args,
          <font color='#0000FF'>typename</font> Helper <font color='#5555FF'>=</font> detail::vectorize_helper<font color='#5555FF'>&lt;</font>
              <b><a name='decltype'></a>decltype</b><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>mem_fn</font><font face='Lucida Console'>(</font>std::declval<font color='#5555FF'>&lt;</font><font color='#BB00BB'>Return</font> <font face='Lucida Console'>(</font>Class::<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>,
              Return,
              <font color='#0000FF'>const</font> Class <font color='#5555FF'>*</font>,
              Args...<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
Helper <b><a name='vectorize'></a>vectorize</b><font face='Lucida Console'>(</font><font color='#BB00BB'>Return</font> <font face='Lucida Console'>(</font>Class::<font color='#5555FF'>*</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>Args...<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font><font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>return</font> <font color='#BB00BB'>Helper</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>mem_fn</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<b><a name='PYBIND11_NAMESPACE_END'></a>PYBIND11_NAMESPACE_END</b><font face='Lucida Console'>(</font>PYBIND11_NAMESPACE<font face='Lucida Console'>)</font>

</pre></body></html>